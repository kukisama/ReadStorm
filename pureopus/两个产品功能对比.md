# ReadStorm 功能对比：C# Avalonia 版 vs pureopus 原生 Android 版

> **生成时间**：2025 年 7 月  
> **目的**：逐功能细粒度对比，找出 pureopus 缺失/不完整的功能点，为后续编码补齐提供可执行的指导依据。  
> **C# 基准**：`src/ReadStorm.Desktop/ViewModels/` (Avalonia + CommunityToolkit.Mvvm)  
> **pureopus 目标**：`pureopus/app/src/main/java/com/readstorm/app/ui/viewmodels/` (Kotlin + LiveData + 协程)

---

## 符号说明

| 符号 | 含义 |
|:---:|:---|
| ✅ | pureopus 已实现，功能对齐 |
| ⚠️ | pureopus 部分实现，逻辑不完整或缺少关键分支 |
| ❌ | pureopus 完全缺失 |

---

## 1. 搜索与下载模块 (SearchDownloadViewModel)

> C# 源: `SearchDownloadViewModel.cs` — 740 行  
> pureopus 源: `SearchDownloadViewModel.kt` — ~310 行

### 1.1 搜索功能

| # | 功能点 | C# 实现细节 | pureopus 状态 | 差异说明 |
|:--|:------|:----------|:---:|:--------|
| 1 | 单书源搜索 | `ExecuteAsync(keyword, sourceId, ct)` | ✅ | 基本对齐 |
| 2 | 聚合健康书源搜索 | 遍历所有 `IsHealthy==true && SearchSupported` 的书源，每源取前 3 条结果，可配置并发数 `AggregateSearchMaxConcurrency`，使用 `SemaphoreSlim` 控制 | ❌ | pureopus 仅支持指定单书源搜索，`SelectedSourceId==0` 时无聚合逻辑。用户选「全部书源」时实际无搜索行为。 |
| 3 | 搜索去重 | 按 `Title|Author|SourceId` GroupBy 去重 | ❌ | pureopus 无搜索结果去重 |
| 4 | 搜索取消/重入 | `_searchCts?.Cancel()` + `_searchSerial` 保证旧搜索不覆盖新搜索结果 | ⚠️ | pureopus 有 CancellationToken 但缺少 serial 机制，可能出现旧结果覆盖新结果 |
| 5 | 空结果区分提示 | `HasNoSearchResults` 区分"未搜索"和"搜索无结果"；指定书源无结果时提示"限流/规则不兼容" | ❌ | pureopus 缺少细粒度状态提示 |
| 6 | 搜索结果书源名回填 | `SearchResult with { SourceName = srcName }` | ⚠️ | pureopus 有书源名但未从 Sources 列表动态回填 |

### 1.2 下载队列

| # | 功能点 | C# 实现细节 | pureopus 状态 | 差异说明 |
|:--|:------|:----------|:---:|:--------|
| 7 | 同书源串行/跨书源并行 | `SourceDownloadQueue.EnqueueAsync(sourceId, action)` | ✅ | pureopus 有 SourceDownloadQueue |
| 8 | 重复任务检测 | `HasActiveDuplicateSearchTask()` — 同名同书源的运行中任务不允许重入 | ❌ | pureopus 无此检查，用户可重复入队同一本书 |
| 9 | 下载期间定期刷新 DB | `PeriodicRefreshDbBooksAsync` 每 1s 刷新 Reader 当前章和 Bookshelf（懒刷新 + 脏标记） | ❌ | **严重缺失**：pureopus 下载期间不刷新 Reader/Bookshelf，用户看不到实时下载进度 |
| 10 | 下载完成回调 | `OnDownloadCompleted` — 成功时自动添加到书架、刷新 Reader、标记书架脏 | ❌ | pureopus 无下载完成回调逻辑 |
| 11 | 活跃下载摘要 | `ActiveDownloadSummary` 如"下载中 3/10" | ❌ | pureopus 无活跃任务摘要文本 |
| 12 | 删除任务确认弹窗 | `DialogHelper.ConfirmAsync` | ❌ | pureopus 直接删除无确认 |

### 1.3 暂停/恢复/批量

| # | 功能点 | C# 实现细节 | pureopus 状态 | 差异说明 |
|:--|:------|:----------|:---:|:--------|
| 13 | 暂停下载 | `PauseDownload` + `_pauseRequested` HashSet + `OverrideToPaused` | ✅ | 基本对齐 |
| 14 | 恢复下载 | `ResumeDownloadTaskAsync` + `ResetForResume` | ✅ | 基本对齐 |
| 15 | 取消下载 | `CancelDownload` | ✅ | 基本对齐 |
| 16 | 重试下载 | `RetryDownloadAsync` + `ResetForRetry` + `RetryCount` 显示 | ✅ | 基本对齐 |
| 17 | **全部停止** | `StopAllDownloads` — 批量暂停所有活跃任务 | ❌ | pureopus 无批量停止 |
| 18 | **全部恢复** | `StartAllDownloadsAsync` — 批量恢复所有暂停任务 | ❌ | pureopus 无批量恢复 |

### 1.4 自动预取 API

| # | 功能点 | C# 实现细节 | pureopus 状态 | 差异说明 |
|:--|:------|:----------|:---:|:--------|
| 19 | 自动预取入口 | `QueueOrReplaceAutoPrefetchAsync(book, startIndex, takeCount, reason)` — 支持 jump/force-current/foreground-direct/manual-priority/low-watermark/gap-fill 等 trigger | ⚠️ | pureopus 有基本预取但缺少多种 trigger 策略和优先级区分 |
| 20 | 冲突任务清理 | `RemoveConflictingTasksForBook` — 跳章时清理同书所有冲突任务 | ❌ | pureopus 不清理冲突任务，可能导致多个预取任务重叠 |
| 21 | 相同范围去重 | 检测 `existingSameRangeActive` 跳过重复范围 | ❌ | pureopus 无范围去重 |
| 22 | 任务状态过滤 | 7 种状态筛选：全部/排队中/下载中/已完成/已失败/已取消/已暂停 | ⚠️ | pureopus 有过滤但状态选项可能不完整 |

---

## 2. 书架模块 (BookshelfViewModel)

> C# 源: `BookshelfViewModel.cs` — 631 行  
> pureopus 源: `BookshelfViewModel.kt` — ~310 行

### 2.1 数据展示与操作

| # | 功能点 | C# 实现细节 | pureopus 状态 | 差异说明 |
|:--|:------|:----------|:---:|:--------|
| 23 | 搜索过滤 | 按书名/作者模糊搜索 `BookshelfFilterText` | ✅ | 基本对齐 |
| 24 | 排序模式 | 4 种：最近阅读/书名/作者/下载进度 | ✅ | 基本对齐 |
| 25 | 导出 TXT | 逐章导出为 UTF-8 无 BOM 文件 | ✅ | 基本对齐 |
| 26 | 导出 EPUB | 通过 `EpubExporter` | ✅ | pureopus 已有 EpubExporter |
| 27 | 删除书籍确认 | `DialogHelper.ConfirmAsync` 弹窗确认 | ❌ | pureopus 直接删除无确认 |
| 28 | 续传下载 | 构造 SearchResult → 入队 DownloadTask | ✅ | 基本对齐 |
| 29 | 刷新封面 | `RefreshCoverAsync` + 刷新 DB 列表 + diagnosticInfo 返回 | ✅ | 基本对齐 |
| 30 | 检查新章节(单本) | `CheckNewChaptersAsync` → 有新章节自动续传 | ⚠️ | pureopus 能检查但**发现新章节后不自动续传** |
| 31 | 检查新章节(全部) | 遍历所有书→逐本 CheckNewChapters→有新自动续传 | ⚠️ | 同上，缺少自动续传衔接 |

### 2.2 高级功能

| # | 功能点 | C# 实现细节 | pureopus 状态 | 差异说明 |
|:--|:------|:----------|:---:|:--------|
| 32 | 大图模式 | `IsBookshelfLargeMode` + `BookshelfLargeColumnCount` 列数切换 | ❌ | pureopus 无大图/列表模式切换 |
| 33 | IsDownloading 状态 | 从 DownloadTasks 实时匹配当前书对应的活跃任务→ `book.IsDownloading=true` | ❌ | pureopus 书架上看不到哪些书正在下载 |
| 34 | 自动补抓缺失封面 | `AutoFetchMissingCoversAsync` — 初始化时扫描无封面书籍并批量抓取 | ❌ | pureopus 不自动补封面，缺封面的书一直空白 |
| 35 | 启动自动续传 | `ResumeIncompleteDownloadsAsync` — 设置开启时启动自动恢复未完成下载 | ❌ | pureopus 有 `autoResumeAndRefreshOnStartup` 设置字段但未实现启动时自动续传逻辑 |
| 36 | 打开书架目录 | `OpenBookshelfDirectory` — 文件资源管理器打开下载目录 | ❌ | pureopus 未实现（Android 可用 Intent 打开文件管理器） |
| 37 | 进度条布局参数 | 6 个可配置参数（左右 padding、总宽度、最小宽度、间距） + `RecalculateProgressLayout` | ❌ | pureopus SettingsVM 有字段但 BookshelfVM 无 recalculate 逻辑 |
| 38 | 脏标记+懒刷新 | `MarkBookshelfDirty()` + `RefreshDbBooksIfNeededAsync(force)` 节流刷新 | ❌ | pureopus 每次操作直接全量刷新，无节流 |
| 39 | 替换书籍保留状态 | `ReplaceDbBookInList(refreshed)` 保留 IsDownloading 状态 | ❌ | pureopus 无此机制 |

---

## 3. 阅读器模块 (ReaderViewModel)

> **差距最大的模块**  
> C# 源: `ReaderViewModel.cs` — **2021 行**  
> pureopus 源: `ReaderViewModel.kt` — **~350 行**

### 3.1 分页与排版

| # | 功能点 | C# 实现细节 | pureopus 状态 | 差异说明 |
|:--|:------|:----------|:---:|:--------|
| 40 | CJK 宽度模型 | `GetCharWidthUnits()`: 全角=1.0, 半角=0.5, 半角片假名=0.5 | ❌ | pureopus 使用简单 `charsPerLine / (fontSize * 0.55)` 估算，不区分全角/半角，**中英混排行尾错位** |
| 41 | 段落逻辑识别 | `BuildLogicalParagraphs()` — 空行/缩进识别段落边界 + `IsParagraphBreak` 标记 | ❌ | pureopus 直接 `split("\n").filter { isNotBlank() }`，无逻辑段落识别 |
| 42 | 段距行数计算 | `spacingLines = round(ParagraphSpacing / effectiveLineHeight)` 插入空行 | ❌ | pureopus 无段距行数计算 |
| 43 | 章首标题格式 | `⌜{chapterTitle}⌝` + 空行 | ❌ | pureopus 无章首标题格式 |
| 44 | 保守行容量算法 | `CalculateConservativeLineCapacity` — 1.5 倍规则：剩余 < 1.5 行高时停止 | ❌ | pureopus 使用 `floor(availableHeight / lineHeight)` 简单除法，末页可能出现半行 |
| 45 | 视口 resize 防抖 | 首次立即生效 + 后续 500ms 防抖 `DebouncedViewportRebuildAsync` | ⚠️ | pureopus 有 `updateViewportSize` 但无防抖，连续 resize 性能差 |
| 46 | 每行字数估算 | `EstimateCharsPerLine()` — 扣除 ContentMargin + HorizontalInnerReservePx + ContentMaxWidth 限制 | ⚠️ | pureopus 计算较粗糙，未考虑 ContentMaxWidth 约束 |
| 47 | 分页重建 | `RebuildChapterPages()` — 按行容量切分 + ShowCurrentPage | ⚠️ | pureopus 有 repaginate 但未集成 CJK 模型和段落逻辑 |

### 3.2 章节导航

| # | 功能点 | C# 实现细节 | pureopus 状态 | 差异说明 |
|:--|:------|:----------|:---:|:--------|
| 48 | 跨章翻页 | 下一页 → 下一章首页；上一页 → 上一章**末页** (`goToLastPage: true`) | ⚠️ | pureopus nextPage→nextChapter 正确，但 previousPage→previousChapter 时**总是跳到首页**而非末页 |
| 49 | 跳章时 DB 快速查库 | `NavigateToChapterAsync` 先 `GetChapterAsync` 检查最新内容 | ❌ | pureopus navigateToChapter 不查库，使用内存中可能过时的章节内容 |
| 50 | 章节状态标签 | Done="", Failed="❌ ", Downloading="⏳ ", Waiting="⬜ " | ❌ | pureopus 仅用 `[未下载]` 前缀，无 Failed/Downloading 细粒度状态 |
| 51 | `_suppressReaderIndexChangedNavigation` | 防止编程式设置 index 时触发多余导航 | ❌ | pureopus 无此保护，可能导致循环触发 |
| 52 | 占位内容检测 | `IsPlaceholderChapterContent()` — 识别 "等待下载"/"正在下载中"/"下载失败" | ❌ | pureopus 仅检查 `content.isBlank()` |
| 53 | 目录关闭时恢复刷新 | `_pendingRefreshWhenTocClosed` — TOC 打开时暂存刷新请求 | ❌ | pureopus 无此机制 |

### 3.3 书签系统

| # | 功能点 | C# 实现细节 | pureopus 状态 | 差异说明 |
|:--|:------|:----------|:---:|:--------|
| 54 | 书签锚文本 | `BuildCurrentPageAnchorText()` 保存首个非空非标题行文本 | ❌ | pureopus 书签 `anchorText = null`，不保存锚文本 |
| 55 | 锚文本跳转 | `FindPageByAnchorText()` — 字体/视口变化后根据锚文本重定位 | ❌ | pureopus 仅依赖 pageIndex 跳转，字体变化后位置漂移 |
| 56 | 书签预览文本 | `BuildCurrentPagePreviewText()` 截取前 48 字 | ⚠️ | pureopus 取前 2 段落 join，截取 100 字，逻辑不同但功能类似 |
| 57 | 书签 UI 状态 | `BookmarkToggleText` / `BookmarkButtonBackground` / `BookmarkButtonForeground` / `BookmarkToolbarForeground` 计算属性 | ❌ | pureopus 有 `isCurrentPageBookmarked` 但无配套 UI 计算属性 |

### 3.4 封面/换源/高级功能

| # | 功能点 | C# 实现细节 | pureopus 状态 | 差异说明 |
|:--|:------|:----------|:---:|:--------|
| 58 | **封面选择器** | `OpenCoverPickerAsync` — 获取候选封面列表 + `ApplySelectedCoverAsync` 应用 | ❌ | pureopus 完全没有封面选择器 |
| 59 | **换源阅读** | `OnSelectedSwitchSourceChanged` → `FetchChapterFromSourceAsync` → 更新章节内容→DB 持久化 | ❌ | pureopus `refreshSortedSwitchSources()` 是空方法体 |
| 60 | 健康书源排序列表 | `SortedSwitchSources` — healthy > unknown > unhealthy | ❌ | 无 |
| 61 | **字体选择** | 7 种字体的 `_fontMap` + `SelectedFontName` → `ReaderFontFamily` | ❌ | pureopus 有 `selectedFontName` 字段但无字体列表和切换逻辑 |
| 62 | 打开书籍网页 | `OpenBookWebPage` — 在浏览器中打开 TocUrl | ❌ | pureopus 无此命令 |
| 63 | TXT 文件阅读 | `ParseTxtChapters` — 中文/英文章节标题正则识别 | ❌ | pureopus 无 TXT 本地文件阅读能力 |

### 3.5 阅读状态持久化

| # | 功能点 | C# 实现细节 | pureopus 状态 | 差异说明 |
|:--|:------|:----------|:---:|:--------|
| 64 | 防抖保存 | `QueuePersistReadingState` 400ms CancellationToken 防抖 | ❌ | pureopus 用 `GlobalScope.launch` fire-and-forget，无防抖，频繁翻页时大量并发写库 |
| 65 | 恢复阅读状态 | `RestoreReadingStateAsync` — 恢复 chapter+page+anchor + `_isApplyingPersistedState` 防循环 | ⚠️ | pureopus 有 `getReadingState` 但无 anchor 恢复，无防循环保护 |
| 66 | Layout fingerprint | `BuildLayoutFingerprint()` — 字号|行高|maxWidth|sidePadding|innerReserve|viewport | ⚠️ | pureopus 有简化版 `fontSize_lineHeight_WxH`，缺少 maxWidth/sidePadding/innerReserve |

### 3.6 自动预取链路

| # | 功能点 | C# 实现细节 | pureopus 状态 | 差异说明 |
|:--|:------|:----------|:---:|:--------|
| 67 | 预取策略 | `ReaderAutoPrefetchPolicy.ShouldQueueWindow(plan, trigger)` + `BuildPlanAsync` | ❌ | pureopus 无预取策略引擎 |
| 68 | 预取 trigger 触发点 | open/jump/low-watermark/foreground-direct/gap-fill/toggle-on/manual-priority | ❌ | pureopus 无任何 trigger 调用 |
| 69 | Gap-fill 补洞 | 检测 `plan.HasGap` + `plan.FirstGapIndex` → 从缺口处补下载 | ❌ | pureopus 无 gap-fill |
| 70 | force-current 防抖 | `ShouldForceCurrentPrefetchNow()` 1s 冷却 + 检查是否有覆盖当前章的活跃任务 | ❌ | 无 |
| 71 | 占位→可读接力预取 | 章节从占位变为可读后立刻 `QueueAutoPrefetch("foreground-direct")` | ❌ | 无 |

### 3.7 属性变更自动保存

| # | 功能点 | C# 实现细节 | pureopus 状态 | 差异说明 |
|:--|:------|:----------|:---:|:--------|
| 72 | 字号/行高/段距变化 | partial method → recalculate + rebuild pages + clamp page + show + auto-save | ❌ | pureopus 属性变化时不触发重排分页和自动保存 |
| 73 | 刘海模式变化 | `OnReaderExtendIntoCutoutChanged` → recalculate insets + repaginate | ❌ | pureopus 有属性但无 change handler |
| 74 | 暗黑模式联动 | `OnIsDarkModeChanged` → 自动设置 background/foreground 颜色 | ⚠️ | pureopus `applyPaperPreset` 有基本判断但无完整联动 |

### 3.8 下载信号智能刷新

| # | 功能点 | C# 实现细节 | pureopus 状态 | 差异说明 |
|:--|:------|:----------|:---:|:--------|
| 75 | 全量 vs 章节刷新 | `ShouldDoFullRefreshFromSignal()` — 章节列表为空或内容空白时全量刷新；否则仅刷新当前章 | ❌ | pureopus `refreshCurrentBookFromDownloadSignal` 每次都全量重载所有章节 |
| 76 | 当前章前台优先下载 | `ShouldForceCurrentPrefetchNow()` + 检查是否有覆盖当前章的任务 | ❌ | 无 |
| 77 | 下载中→可读实时切换 | 章节从占位变 Done 后立即更新当前页面内容 | ⚠️ | pureopus 有基本更新但无占位→可读的精确检测 |

---

## 4. 设置模块 (SettingsViewModel)

> C# 源: `SettingsViewModel.cs` — 724 行  
> pureopus 源: `SettingsViewModel.kt` — ~200 行

| # | 功能点 | C# 实现细节 | pureopus 状态 | 差异说明 |
|:--|:------|:----------|:---:|:--------|
| 78 | 基础配置字段 | 下载并发/聚合并发/间隔/导出格式/诊断日志/自动续传/预取参数 | ✅ | 字段对齐 |
| 79 | **代理设置** | `ProxyEnabled` / `ProxyHost` / `ProxyPort` | ❌ | pureopus 无代理设置 |
| 80 | **浏览选择目录** | `BrowseDownloadPathAsync` — Avalonia FolderPicker / Android SAF | ❌ | pureopus 无目录选择器，下载路径只能用默认值 |
| 81 | 导出诊断日志 | Android: MediaStore API29+ 写入 Download/ReadStorm；Desktop: FilePicker | ✅ | pureopus 有 `exportDiagnosticLog` 用 `WorkDirectoryManager.exportToPublicDownloads` |
| 82 | 导出数据库 | **WAL checkpoint** (`PRAGMA wal_checkpoint(TRUNCATE)`) + 拷贝 | ⚠️ | pureopus 有 `exportDatabase` 但**无 WAL checkpoint**，导出的 DB 可能不完整 |
| 83 | **工作目录变更重启** | 检测路径变化 → `DialogHelper.ConfirmAsync("是否立即重启？")` → `RestartDesktopApplication` | ❌ | pureopus 无路径变更检测和重启提示 |
| 84 | 自动保存防抖 | `QueueAutoSaveSettings` 500ms CancellationToken | ✅ | pureopus 有相同逻辑 |
| 85 | 属性变化同步 Reader | partial method → `_parent.Reader.ReaderXxx = value` | ✅ | pureopus 在 loadSettings 中一次性同步，但实时变更未同步 |
| 86 | 属性变化同步 Bookshelf | partial method → `_parent.Bookshelf.BookshelfProgressXxx = value` | ❌ | pureopus 设置变化不同步书架进度条参数 |
| 87 | 桌面窗口最小宽度 | `_parent.UpdateDesktopWindowMinWidth(value)` | N/A | Android 不适用 |
| 88 | 书架进度条 6 参数 | Left/Right Padding, TotalWidth, MinWidth, BarToPercentGap, PercentTailGap | ⚠️ | pureopus 有字段但缺少实时 recalculate 和 UI 联动 |
| 89 | 关于版本 | `AboutInfoProvider.Get()` | ✅ | pureopus 用 `PackageManager` 获取版本 |

---

## 5. 诊断模块 (DiagnosticViewModel)

> C# 源: `DiagnosticViewModel.cs` — ~100 行  
> pureopus 源: `DiagnosticViewModel.kt` — ~100 行

| # | 功能点 | C# 实现细节 | pureopus 状态 | 差异说明 |
|:--|:------|:----------|:---:|:--------|
| 90 | 批量诊断 | 并行诊断所有书源，Semaphore 控制并发 | ✅ | pureopus 使用 Semaphore(10)，对齐 |
| 91 | 增量 UI 更新 | 每完成一个书源立即刷新 sourceNames 列表 | ✅ | 对齐 |
| 92 | 诊断详情展示 | 选择书源后显示 diagnosticLines | ✅ | 对齐 |
| 93 | 进度显示 | "诊断中 (X/Y)…" | ✅ | 对齐 |

> 🟢 **诊断模块是 pureopus 实现最完整的模块，基本 100% 对齐。**

---

## 6. 规则编辑器模块 (RuleEditorViewModel)

> C# 源: `RuleEditorViewModel.cs` — 897 行  
> pureopus 源: `RuleEditorViewModel.kt` — 462 行

| # | 功能点 | C# 实现细节 | pureopus 状态 | 差异说明 |
|:--|:------|:----------|:---:|:--------|
| 94 | 加载规则列表 | 从文件加载 + 关联健康状态 | ✅ | 对齐 |
| 95 | 保存规则 | UpsertRule | ✅ | 对齐 |
| 96 | 新建规则 | `nextId = max(allRules.id) + 1` | ✅ | 对齐 |
| 97 | 复制规则 | `copy(id = nextId, name = "${name} (副本)")` | ✅ | 对齐 |
| 98 | 删除规则 | `delete(rule.id)` | ✅ | 对齐 |
| 99 | 恢复默认 | `resetToDefault(rule.id)` | ✅ | 对齐 |
| 100 | 测试规则(搜索) | testSearch → 显示搜索结果 | ✅ | 对齐 |
| 101 | 测试规则(目录) | testToc → 显示目录结果 | ✅ | 对齐 |
| 102 | **测试规则(正文)** | 三步测试：search→toc→**chapter** 完整链路 | ⚠️ | pureopus testRule 只做了 search→toc 两步，**缺少第三步 chapter 正文测试** |
| 103 | Debug 完整报告 | 三步调试：搜索→目录→正文，生成完整 Markdown 报告 | ✅ | pureopus debugRule 三步完整，报告格式对齐 |
| 104 | **过滤文本追加** | 选中文本 → 追加到规则过滤器字段 | ❌ | pureopus 无此功能 |
| 105 | 健康状态同步 | `syncRuleEditorRuleHealthFromSources` | ✅ | 对齐 |
| 106 | 用户覆写标记 | `ruleHasUserOverride` | ✅ | 对齐 |

---

## 7. 主框架 (MainWindowViewModel / MainViewModel)

| # | 功能点 | C# 实现细节 | pureopus 状态 | 差异说明 |
|:--|:------|:----------|:---:|:--------|
| 107 | Tab 管理 | 8 个 Tab + About | ✅ | pureopus 有 7-8 个 Tab |
| 108 | 懒初始化 | SemaphoreSlim 保护每个子模块 | ✅ | pureopus 用 `isInitialized` + 协程 |
| 109 | Reader Tab 隐藏 | `IsReaderTabVisible` 初始隐藏，打开书后才显示 | ⚠️ | pureopus 可能始终显示 Reader Tab |
| 110 | `SafeFireAndForgetAsync` | 通用异常吞咽工具方法 | ❌ | pureopus 无此通用工具 |
| 111 | 启动时自动健康检查 | 初始化时触发 `RefreshSourceHealthAsync` | ⚠️ | pureopus 需确认是否启动时自动检查 |
| 112 | `OpenDbBookAndSwitchToReaderAsync` | 打开书+切换 tab 的组合操作 | ✅ | pureopus 通过 `openReaderEvent` LiveData |

---

## 8. 优先级排序：按影响面分级

### 🔴 P0 — 核心体验缺损（影响日常使用）

| 优先级 | 功能 | 对应编号 | 工作量估算 |
|:---:|:------|:---:|:---:|
| P0-1 | 聚合健康书源搜索 | #2 | 1-2 天 |
| P0-2 | 下载期间定期刷新 Reader/Bookshelf | #9 | 1 天 |
| P0-3 | 下载完成回调 + 书架自动添加 | #10 | 0.5 天 |
| P0-4 | CJK 宽度模型分页 | #40 | 1-2 天 |
| P0-5 | 跨章翻页：上一页→上一章末页 | #48 | 0.5 天 |
| P0-6 | 阅读状态防抖保存 + 锚文本 | #54, #55, #64, #65 | 1 天 |
| P0-7 | 换源阅读 | #59 | 1-2 天 |
| P0-8 | 跳章时 DB 查库刷新 | #49 | 0.5 天 |

### 🟡 P1 — 重要功能缺失（影响完整度）

| 优先级 | 功能 | 对应编号 | 工作量估算 |
|:---:|:------|:---:|:---:|
| P1-1 | 自动预取策略引擎 | #67-#71 | 2-3 天 |
| P1-2 | 封面选择器 | #58 | 1 天 |
| P1-3 | 字体选择 (7 种) | #61 | 0.5 天 |
| P1-4 | 代理设置 | #79 | 0.5 天 |
| P1-5 | 自动补抓缺失封面 | #34 | 0.5 天 |
| P1-6 | 启动自动续传 | #35 | 0.5 天 |
| P1-7 | 重复下载任务检测 | #8 | 0.5 天 |
| P1-8 | 冲突预取任务清理 | #20, #21 | 1 天 |
| P1-9 | 段落逻辑识别 + 章首标题格式 | #41, #42, #43 | 1 天 |
| P1-10 | 章节状态标签 (Done/Failed/Downloading/Waiting) | #50 | 0.5 天 |

### 🟢 P2 — 体验优化（影响打磨度）

| 优先级 | 功能 | 对应编号 | 工作量估算 |
|:---:|:------|:---:|:---:|
| P2-1 | 批量停止/恢复 | #17, #18 | 0.5 天 |
| P2-2 | 删除确认弹窗 | #12, #27 | 0.5 天 |
| P2-3 | 大图模式 | #32 | 1 天 |
| P2-4 | IsDownloading 状态标记 | #33 | 0.5 天 |
| P2-5 | 活跃下载摘要 | #11 | 0.5 天 |
| P2-6 | 脏标记+懒刷新 | #38, #39 | 1 天 |
| P2-7 | 浏览选择目录 | #80 | 0.5 天 |
| P2-8 | 导出 DB 时 WAL checkpoint | #82 | 0.5 天 |
| P2-9 | 属性变化实时同步 | #72, #73, #74, #85, #86 | 1 天 |
| P2-10 | 视口 resize 防抖 | #45 | 0.5 天 |
| P2-11 | 全量 vs 章节智能刷新 | #75, #76, #77 | 1 天 |
| P2-12 | 测试规则第三步(正文) | #102 | 0.5 天 |
| P2-13 | 过滤文本追加 | #104 | 0.5 天 |
| P2-14 | 打开书籍网页 | #62 | 0.5 天 |
| P2-15 | 空结果区分提示 | #5 | 0.5 天 |
| P2-16 | 工作目录变更重启提示 | #83 | 0.5 天 |
| P2-17 | 目录关闭时恢复刷新 | #53 | 0.5 天 |
| P2-18 | suppressNavigation 保护 | #51 | 0.5 天 |
| P2-19 | 保守行容量 1.5 倍规则 | #44 | 0.5 天 |
| P2-20 | 书签 UI 计算属性 | #57 | 0.5 天 |

---

## 9. 总体统计

| 类别 | 总数 | ✅ 对齐 | ⚠️ 部分 | ❌ 缺失 |
|:-----|:---:|:---:|:---:|:---:|
| 搜索下载 | 22 | 7 | 3 | 12 |
| 书架 | 17 | 6 | 2 | 9 |
| 阅读器 | 38 | 0 | 10 | 28 |
| 设置 | 12 | 5 | 3 | 4 |
| 诊断 | 4 | 4 | 0 | 0 |
| 规则编辑 | 13 | 10 | 1 | 2 |
| 主框架 | 6 | 3 | 2 | 1 |
| **合计** | **112** | **35 (31%)** | **21 (19%)** | **56 (50%)** |

> **pureopus 当前功能覆盖率约 31%（完全对齐）+ 19%（部分实现）= ~50%。**  
> **最大短板在阅读器模块（2021 行 vs 350 行），几乎所有高级功能均缺失。**

---

## 10. 推荐实施路径

```
Phase 1（P0，6-8 天）：核心体验补齐
  ├── 聚合搜索 → 下载刷新链路 → 完成回调
  ├── CJK 分页 → 跨章末页 → 跳章查库
  ├── 阅读状态防抖 + 锚文本
  └── 换源阅读

Phase 2（P1，8-10 天）：功能完整度
  ├── 自动预取策略引擎（最复杂）
  ├── 封面选择器 + 自动补封面
  ├── 字体选择 + 代理设置
  ├── 启动自动续传 + 重复检测
  ├── 段落逻辑排版
  └── 章节状态标签

Phase 3（P2，10-15 天）：打磨优化
  ├── UI 交互（确认弹窗/大图模式/下载摘要）
  ├── 性能（脏标记/防抖/智能刷新）
  ├── 设置联动（实时同步/WAL checkpoint）
  └── 规则编辑器增强
```

**总预估工作量：25-35 人天**
