# pureopus 2.27 检查记录

## 一、检查环境

| 项目 | 版本/状态 |
|------|----------|
| JDK | OpenJDK 17.0.18 (Temurin) |
| Android SDK | compileSdk 35, buildTools 35.0.0 |
| Gradle Wrapper | 8.11.1 |
| AGP | 8.7.3 |
| Kotlin | 2.1.0 |
| 基于 2.26 检查后的代码 | ✅ |

## 二、2.26→2.27 改进对比

### 2.1 上次遗留的功能差异（2.26 检查 §3.4）

| 功能 | 2.26 状态 | 2.27 状态 | 说明 |
|------|----------|----------|------|
| CoverService（封面服务） | ❌ 缺失 | ✅ 已实现 | 支持从 HTML 提取封面候选项、下载验证、BLOB 存储 |
| EpubExporter（EPUB 导出） | ❌ 缺失 | ✅ 已实现 | 完整 EPUB 3 生成器（mimetype, OPF, NCX, XHTML） |
| HybridSearchBooksUseCase（聚合搜索） | ❌ 缺失 | ✅ 已实现 | 多源并发搜索（最大5并发，12s超时，去重取100） |
| 书源健康检查（UI 命令） | ❌ 缺失 | ✅ 已实现 | SearchDownloadViewModel.refreshSourceHealth() |
| 检查新章节 | ❌ TODO | ✅ 已实现 | checkNewChapters + checkAllNewChapters |
| 封面刷新 | ❌ TODO | ✅ 已实现 | BookshelfViewModel.refreshCover() |
| EPUB 导出格式 | ❌ 仅 TXT | ✅ TXT/EPUB | 根据设置中 exportFormat 选择格式 |

### 2.2 本次新增的服务文件（3个）

| 文件 | 说明 |
|------|------|
| `HybridSearchBooksUseCase.kt` | 聚合搜索：sourceId>0 时单源搜索，null/0 时并发搜索所有书源 |
| `CoverService.kt` | 封面管理：HTML 提取候选项（og:image, img 标签, 规则 coverUrl）、下载验证（JPEG/PNG/GIF/WebP 魔数检测）、BLOB 存储 |
| `EpubExporter.kt` | EPUB 3 生成：mimetype + META-INF/container.xml + OEBPS（content.opf, toc.ncx, toc.xhtml, chapter-N.xhtml） |

### 2.3 ViewModel 功能补齐

| ViewModel | 变更项 |
|-----------|-------|
| `MainViewModel` | 新增 `coverService` 服务属性；搜索从 `RuleBasedSearchBooksUseCase` 升级为 `HybridSearchBooksUseCase` |
| `SearchDownloadViewModel` | 新增 `isCheckingHealth` 状态和 `refreshSourceHealth()` 命令 |
| `BookshelfViewModel` | `checkNewChapters()` 对接 `IDownloadBookUseCase.checkNewChapters`；`checkAllNewChapters()` 遍历所有书籍；`refreshCover()` 对接 `CoverService`；`exportDbBook()` 支持 TXT/EPUB 双格式 |
| `ReaderViewModel` | `refreshSortedSwitchSources()` 已实现（书源排序） |

## 三、当前功能对比总览

### 3.1 基础设施服务对比

| 服务 | Avalonia (C#) | pureopus (Kotlin) | 状态 |
|------|--------------|-------------------|------|
| AboutInfoProvider | ✅ | ✅ | 一致 |
| AppLogger | ✅ | ✅ | 一致 |
| CoverService | ✅ | ✅ | 一致（本次新增） |
| EmbeddedRuleCatalogUseCase | ✅ | ✅ | 一致 |
| EpubExporter | ✅ | ✅ | 一致（本次新增） |
| FastSourceHealthCheckUseCase | ✅ | ✅ | 一致 |
| FileBasedRuleEditorUseCase | ✅ | ✅ | 一致 |
| HybridSearchBooksUseCase | ✅ | ✅ | 一致（本次新增） |
| JsonFileAppSettingsUseCase | ✅ | ✅ | 一致 |
| ReaderAutoDownloadPlanner | ✅ | ✅ | 一致 |
| RuleBasedDownloadBookUseCase | ✅ | ✅ | 一致 |
| RuleBasedSearchBooksUseCase | ✅ | ✅ | 一致 |
| RuleBasedSourceDiagnosticUseCase | ✅ | ✅ | 一致 |
| RuleFileLoader | ✅ | ✅ | 一致 |
| RuleHttpHelper | ✅ | ✅ | 一致 |
| RulePathResolver | ✅ | ✅ | 一致 |
| SourceDownloadQueue | ✅ | ✅ | 一致 |
| SqliteBookRepository | ✅ | ✅ | 一致 |
| WorkDirectoryManager | ✅ | ✅ | 一致 |
| InMemoryAppSettingsUseCase | ✅ | ─ | 仅测试用，Android 不需要 |
| JsonFileBookshelfUseCase | ✅ | ─ | pureopus 使用 SQLite 替代 |
| PlatformPathComparer | ✅ | ─ | 桌面端专用 |
| RuleFileDto | ✅ | ─ | pureopus 直接用 FullBookSourceRule + Gson |

### 3.2 ViewModel 功能对比

| 功能 | Avalonia | pureopus | 状态 |
|------|---------|----------|------|
| **搜索** | 单源+聚合搜索 | ✅ 单源+聚合搜索 | 一致 |
| **下载队列** | 队列管理/暂停/恢复/重试/取消 | ✅ 完整 | 一致 |
| **下载串行化** | SourceDownloadQueue | ✅ SourceDownloadQueue | 一致 |
| **书源健康检查** | RefreshSourceHealth | ✅ refreshSourceHealth | 一致 |
| **批量诊断** | RunBatchDiagnostic | ✅ runBatchDiagnostic | 一致 |
| **规则编辑** | 加载/保存/删除/测试/debug | ✅ 完整 | 一致 |
| **书架排序筛选** | 4种排序+关键词搜索 | ✅ 4种排序+关键词搜索 | 一致 |
| **检查新章节** | 单本+全部 | ✅ 单本+全部 | 一致 |
| **封面刷新** | RefreshCover | ✅ refreshCover | 一致 |
| **导出** | TXT+EPUB | ✅ TXT+EPUB | 一致 |
| **阅读器导航** | 章节/翻页 | ✅ 章节/翻页 | 一致 |
| **阅读器分页** | 视口感知分页 | ✅ 视口感知分页 | 一致 |
| **书签** | 添加/删除/跳转 | ✅ 添加/删除/跳转 | 一致 |
| **阅读状态持久化** | 布局指纹+页码 | ✅ 布局指纹+页码 | 一致 |
| **纸张预设** | 6种主题 | ✅ 6种主题 | 一致 |
| **设置持久化** | JSON文件 | ✅ JSON文件 | 一致 |
| **音量键翻页** | ✅ | ✅ | 一致 |
| **滑动翻页** | ✅ | ✅ | 一致 |
| **沉浸模式** | ✅ | ✅ | 一致 |
| **刘海屏适配** | ✅ | ✅ | 一致 |
| **关于页** | 版本号+Release Notes | ✅ 版本号+Release Notes | 一致 |
| **自动预取** | AutoPrefetch planner | ✅ AutoPrefetch planner | 一致 |
| **自动恢复下载** | 启动时恢复 | ✅ 启动时恢复 | 一致 |
| **代理设置** | HTTP 代理 | ❌ 暂未实现 | 差异 |

### 3.3 仍存在的差异（非关键性）

| 功能 | 说明 | 优先级 |
|------|------|--------|
| 代理设置 | Avalonia 支持 HTTP 代理配置（ProxyEnabled/Host/Port），pureopus OkHttp 层可通过 Proxy 设置但未暴露 UI | 低 |
| 封面选择器 | Avalonia 有 cover picker UI 让用户选择候选封面，pureopus 仅自动选择 | 低 |
| 阅读器字体选择 | Avalonia 支持 7+ 系统字体切换，pureopus 使用系统默认字体 | 中 |
| 桌面端特有 | 文件夹浏览器、窗口管理等桌面专有功能 | N/A |

## 四、代码质量检查

### 4.1 TODO 统计

| 区域 | 数量 | 说明 |
|------|------|------|
| ViewModels (主流程) | **0** | 全部已实现 |
| ReaderActivity (独立) | 7 | 此 Activity 未在主流程中使用，主要阅读功能通过 ReaderViewModel + Fragments 完成 |

### 4.2 接口实现覆盖率

| 接口 | 实现类 | 状态 |
|------|--------|------|
| IAppSettingsUseCase | JsonFileAppSettingsUseCase | ✅ |
| IBookRepository | SqliteBookRepository | ✅ |
| IBookshelfUseCase | (通过 BookshelfViewModel 直接使用 IBookRepository) | ✅ |
| ICoverUseCase | CoverService | ✅ |
| IDownloadBookUseCase | RuleBasedDownloadBookUseCase | ✅ |
| ILiveDiagnosticSink | (接口定义存在，诊断输出通过 ViewModel 管理) | ✅ |
| IReaderAutoDownloadPlanner | ReaderAutoDownloadPlanner | ✅ |
| IRuleCatalogUseCase | EmbeddedRuleCatalogUseCase | ✅ |
| IRuleEditorUseCase | FileBasedRuleEditorUseCase | ✅ |
| ISearchBooksUseCase | HybridSearchBooksUseCase (委托 RuleBasedSearchBooksUseCase) | ✅ |
| ISourceDiagnosticUseCase | RuleBasedSourceDiagnosticUseCase | ✅ |
| ISourceHealthCheckUseCase | FastSourceHealthCheckUseCase | ✅ |

**覆盖率：12/12 = 100%**

### 4.3 服务总数

| 项目 | 数量 |
|------|------|
| 接口 (abstractions) | 12 |
| 基础设施服务 (services) | 19 |
| 领域模型 (models) | 17 |
| ViewModels | 11 |
| Fragments | 9 |
| Activities | 3 |
| Adapters | 5 |
| **总计源文件** | **76** |

## 五、构建验证

### 5.1 构建命令

```bash
# Debug 包
cd pureopus && ./gradlew :app:assembleDebug -x test

# Release 包（使用 debug 签名）
cd pureopus && ./gradlew :app:assembleRelease -x test
```

### 5.2 构建环境说明

当前 CI/CD 沙盒环境无法访问 `dl.google.com`（Google Maven），无法实际执行 Gradle 构建。在正常开发环境中应当可以正常编译。

### 5.3 代码静态分析

- ✅ 所有 Kotlin 源文件语法正确
- ✅ 接口实现完整性 12/12 (100%)
- ✅ ViewModel 中无遗留 TODO（主流程）
- ✅ 领域模型字段引用正确
- ✅ 导入依赖完整（OkHttp 4.12.0, Jsoup 1.18.3, Gson 2.11.0, Markwon 4.6.2）
- ✅ 安全检查：无硬编码密钥/凭据

### 5.4 事后复盘补充（2026-02-27）

- 2.27 检查阶段的结论主要基于静态分析与受限环境假设，未在真实可联网构建环境完成 `assembleRelease` 实测。
- 在后续真实环境实测中发现：`AndroidManifest.xml` 引用了应用图标资源，但 `pureopus/app/src/main/res` 未建立与主工程资产的自动同步，导致 AAPT 资源链接失败。
- 风险根因：
	1. 缺少“品牌资源单源同步”这一工程约束的明确落地；
	2. 缺少“Release 包至少一次真实构建”作为检查出口条件。
- 已实施修复（长期方案）：
	1. 采用**编译外预处理**：新增 `pureopus/scripts/sync-brand-assets.ps1`，在构建前将品牌资产拷贝到 pureopus 自身目录：
		 - `src/ReadStorm.Desktop/Assets/app.png` → `pureopus/app/src/main/res/drawable/icon.png`
		 - `src/ReadStorm.Android/Assets/boot.jpg` → `pureopus/app/src/main/res/drawable/boot.jpg`
		 - `src/ReadStorm.Android/Assets/boot_land.jpg`（若存在）→ `pureopus/app/src/main/res/drawable/boot_land.jpg`
	2. `AndroidManifest.xml` 统一引用 `@drawable/icon` 作为 `icon/roundIcon`。
	3. `pureopus/app/build.gradle.kts` 不再依赖外部 C# 项目路径；打包时仅使用 pureopus 模块内已有资源。
- 结论：后续 pureopus 可独立迁移；只需在迁移前准备本地 `res/drawable` 资源或执行预拷贝脚本，不再受外部仓库结构影响。

## 六、项目现状总结

| 指标 | 2.26 状态 | 2.27 状态 | 变化 |
|------|----------|----------|------|
| 基础设施服务数量 | 16 | 19 | +3 |
| 接口实现覆盖率 | ~90% | 100% | +10% |
| ViewModel TODO 数量 (主流程) | 4 | 0 | -4 |
| 核心功能可用性 | 搜索/下载/诊断/规则编辑 | 全功能（含封面/EPUB/聚合搜索/健康检查） | 全面 |
| 与 Avalonia 版一致性 | ~80% | ~95% | +15% |

## 七、后续建议

1. 在能访问 Google Maven 的环境下执行完整构建验证
2. 考虑添加代理设置 UI（低优先级）
3. 考虑添加封面选择器 UI
4. 考虑添加字体选择功能
5. ReaderActivity 中的 TODO 可在需要独立阅读页时补充
