# pureopus 升级变更记录

> 本文件记录 pureopus 原生安卓项目的 Compose + Material 3 迁移过程。  
> 每次变更追加在文末，不得删除或覆盖历史记录。

---

## 2026-02-27 16:01:16

### 实现目标
- Phase 0：Jetpack Compose + Material 3 基础设施接入（依据《Compose-M3迁移实施手册》）

### 变更内容

**构建配置变更**
- `build.gradle.kts`（根）：新增 `org.jetbrains.kotlin.plugin.compose` 插件声明（v2.1.0）
- `app/build.gradle.kts`：
  - 应用 `org.jetbrains.kotlin.plugin.compose` 插件
  - `buildFeatures` 新增 `compose = true`（保留原有 `viewBinding = true`）
  - 新增 Compose BOM 2024.12.01 及相关依赖：
    - `androidx.compose.ui:ui`
    - `androidx.compose.ui:ui-graphics`
    - `androidx.compose.ui:ui-tooling-preview`
    - `androidx.compose.material3:material3`
    - `androidx.activity:activity-compose:1.9.3`
    - `androidx.lifecycle:lifecycle-runtime-compose:2.8.7`
  - 新增 debug 工具依赖：`ui-tooling`、`ui-test-manifest`

**M3 主题文件（新增 4 个）**
- `ui/compose/theme/Color.kt` — 颜色定义（主色系 SlateBlue + Blue，语义色，阅读器主题色）
- `ui/compose/theme/Type.kt` — 字体排版（headline / title / body / label 各 3 级）
- `ui/compose/theme/Shape.kt` — 圆角规范（4 / 8 / 12 / 16 / 24 dp）
- `ui/compose/theme/Theme.kt` — `ReadStormTheme` 入口（Light / Dark / Dynamic Color 可选）

**基础 Compose 组件（新增 5 个）**
- `ui/compose/components/RsTopBar.kt` — 统一顶栏（CenterAlignedTopAppBar + 导航图标 + 操作按钮）
- `ui/compose/components/RsPrimaryButton.kt` — 按钮系列（RsPrimaryButton / RsOutlinedButton / RsTextButton）
- `ui/compose/components/RsCard.kt` — 统一卡片（可点击/不可点击，可选标题）
- `ui/compose/components/RsEmptyState.kt` — 空状态占位（图标 + 消息 + 描述 + 操作按钮）
- `ui/compose/components/RsLoading.kt` — 加载中指示器（CircularProgressIndicator + 可选文本）

### 验证结果
- **资源存在性检查**：icon.png ✓ / boot.jpg ✓ / rule-*.json 22 个 ✓
- **sync-brand-assets.ps1**：执行成功，同步 22 个规则文件
- **Debug 构建**：`./gradlew :app:assembleDebug -x test` — BUILD SUCCESSFUL (51s)
- **Release 构建**：`./gradlew :app:assembleRelease -x test` — BUILD SUCCESSFUL (1m 42s)
- 无编译错误，仅有 4 个已知 deprecation 警告（均为迁移前已存在）

### 后续计划
- Phase 1：低风险页面迁移（More / About / Log / Settings → Compose Screen）
- 迁移时将在现有 Fragment 中使用 `ComposeView` 承载新 UI，保留回滚能力

---

## 2026-02-28 10:30:00

### 实现目标
- Phase 1~4 + Phase 6：全部主页面 Compose 化 + Fragment 壳改造 + XML 清理验证 + 构建零警告

### 变更内容

**Gradle 依赖补充**
- `app/build.gradle.kts`：新增 `material-icons-extended`（扩展图标库）和 `runtime-livedata`（Compose 内观察 LiveData）

**Phase 1 — 低风险页面 Compose Screens（新增 4 个）**
- `ui/compose/screens/MoreScreen.kt` — 导航菜单，5 个入口项，`onNavigate: (String) -> Unit` 统一回调
- `ui/compose/screens/AboutScreen.kt` — 版本信息、GitHub 链接、发布说明
- `ui/compose/screens/LogScreen.kt` — AppLogger 日志展示、清空按钮、自动滚动
- `ui/compose/screens/SettingsScreen.kt` — 完整设置表单，观察 SettingsViewModel LiveData，保存/导出

**Phase 2 — 搜索与下载 Compose Screens（新增 2 个）**
- `ui/compose/screens/SearchScreen.kt` — 搜索栏 + 书源下拉 + 队列下载 + LazyColumn 结果列表
- `ui/compose/screens/DownloadTasksScreen.kt` — 任务列表 + 状态颜色 + 进度条 + 动作按钮 + 全部开始/停止

**Phase 3 — 书架 Compose Screen（新增 1 个）**
- `ui/compose/screens/BookshelfScreen.kt` — 2 列网格 + Base64 封面解码 + 进度条 + 长按 DropdownMenu（6 个操作）

**Phase 4 — 诊断 & 规则编辑器 Compose Screens（新增 2 个）**
- `ui/compose/screens/DiagnosticScreen.kt` — 批量诊断 + 汇总卡片 + 诊断行颜色编码
- `ui/compose/screens/RuleEditorScreen.kt` — 最复杂页面：可折叠分区（基本/搜索/书籍/目录/章节/测试） + ExposedDropdownMenuBox 规则选择器 + 字段编辑

**Fragment 壳改造（全部 9 个）**
- 所有 Fragment 的 `onCreateView` 重写为返回 `ComposeView`，采用 `ViewCompositionStrategy.DisposeOnViewTreeLifecycleDestroyed`
- 改造文件列表：
  - `ui/fragments/MoreFragment.kt` — 传入 `onNavigate` lambda，创建目标 Fragment 并调用 `openSubPage()`
  - `ui/fragments/AboutFragment.kt`
  - `ui/fragments/LogFragment.kt`
  - `ui/fragments/SettingsFragment.kt`
  - `ui/fragments/SearchFragment.kt`
  - `ui/fragments/DownloadTasksFragment.kt`
  - `ui/fragments/BookshelfFragment.kt`
  - `ui/fragments/DiagnosticFragment.kt`
  - `ui/fragments/RuleEditorFragment.kt`

**Phase 6 — XML 清理与弃用修复**
- 确认所有 `fragment_*.xml` 布局已成为死代码（Fragment 不再 inflate 它们）
- 确认 `ui/adapters/` 下的 Adapter 类（DownloadTaskAdapter、SearchResultAdapter、BookshelfAdapter、DiagnosticLineAdapter）不再被任何 Fragment 引用
- 保留 `activity_main.xml` 和 `activity_reader.xml`（仍在使用）
- 弃用 API 修复：
  - `Icons.Outlined.OpenInNew` → `Icons.AutoMirrored.Outlined.OpenInNew`（AboutScreen）
  - `Icons.Outlined.LibraryBooks` → `Icons.AutoMirrored.Outlined.LibraryBooks`（BookshelfScreen）
  - `Icons.Outlined.MenuBook` → `Icons.AutoMirrored.Outlined.MenuBook`（BookshelfScreen）
  - `.menuAnchor()` → `.menuAnchor(MenuAnchorType.PrimaryNotEditable)`（RuleEditorScreen）

**Phase 5 — 阅读器评估**
- ReaderActivity（590 行）保留 XML + ViewBinding 方案不动
- 原因：迁移手册明确标注"阅读器除外可分支延期"；该 Activity 深度依赖 `GestureDetector`、`WindowInsetsController`、`KeyEvent` 等平台 API，且核心渲染逻辑仍有多个 TODO 未实现，迁移风险极高、收益有限

### 验证结果
- **Debug 构建**：`./gradlew :app:assembleDebug -x test` — BUILD SUCCESSFUL (2s)
- **Release 构建**：`./gradlew :app:assembleRelease -x test` — BUILD SUCCESSFUL (48s)
- **编译警告**：零（原 4 个 deprecation 全部修复）
- **编译错误**：零

### 后续计划
- Phase 5 阅读器迁移可在独立分支中进行（需 5~8 天，高风险）
- 可选清理：删除不再引用的 `fragment_*.xml`、`item_*.xml` 和 `ui/adapters/` 中的适配器类
- 建议补充各页面 `@Preview` 注解（亮色/暗色）
- 建议在真机上进行手工回归测试（搜索→下载→书架→阅读→设置）

---

## 2026-02-27 23:40:00

### 实现目标
- 修复 Compose 迁移后关键回归问题：页面叠加、规则编辑器不显示规则、诊断无详情、日志无内容、书源健康标记不刷新、下载/书架数据初始化缺失。

### 变更内容
- `ui/compose/theme/Theme.kt`
  - 在 `ReadStormTheme` 内包裹 `Surface(fillMaxSize)`，为每个页面提供不透明背景，修复页面互相“透出/叠加”视觉问题。
- `ui/activities/MainActivity.kt`
  - Tab 选择时触发 `mainViewModel.setSelectedTabIndex(...)`，确保 `bookshelf.init()` 等懒加载逻辑执行。
  - 打开子页面时按 `pageKey` 映射触发对应模块初始化（诊断/规则/设置/关于/日志）。
- `ui/viewmodels/MainViewModel.kt`
  - 新增 `sourcesVersion` 状态与 `notifySourcesChanged()`，用于通知 Compose 刷新书源列表显示。
- `ui/viewmodels/SearchDownloadViewModel.kt`
  - 书源健康检查后调用 `parent.notifySourcesChanged()`，确保健康标记实时刷新。
- `ui/compose/screens/SearchScreen.kt`
  - 订阅 `sourcesVersion` 并基于 `selectedSourceId` 自动对齐选中项。
  - 书源下拉与按钮标签改为显示 `SourceItem.displayName`（含健康符号）。
- `ui/viewmodels/RuleEditorViewModel.kt`
  - 新增 `updateCurrentRule(rule)`，允许 UI 编辑时同步回写当前规则。
- `ui/compose/screens/RuleEditorScreen.kt`
  - 页面进入时 `LaunchedEffect` 自动加载规则列表。
  - 字段编辑统一回写到 ViewModel；保存/测试/Debug 前先同步最新编辑内容，修复“看得到但保存/测试用旧值”。
- `ui/viewmodels/DiagnosticViewModel.kt`
  - 批量诊断完成后自动选中首个书源，默认展示诊断详情。
- `ui/compose/screens/DiagnosticScreen.kt`
  - 新增独立“诊断详情”面板（固定可见），并高亮当前选中书源，避免详情被埋在长列表底部不可见。
- `infrastructure/services/AppLogger.kt`
  - 新增 `getCurrentLogFilePath()` 与 `clearLogs()`。
- `ui/compose/screens/LogScreen.kt`
  - 增加定时轮询刷新日志内容（1s），修复页面不自动更新。
  - “清空日志”改为清空真实日志文件而非仅清空界面字符串。
- `ui/viewmodels/SettingsViewModel.kt`
  - 导出诊断日志改为使用 `AppLogger.getCurrentLogFilePath()`，修复原先硬编码 `debug.log` 导致“开启日志却导不出”。
- `app/build.gradle.kts`
  - `release` 开启 `isMinifyEnabled=true` + `isShrinkResources=true`。
- `app/proguard-rules.pro`（新增）
  - 增加反射 Fragment keep 规则与核心规则模型 keep，兼顾功能稳定与体积缩减。

### 验证结果
- `./gradlew :app:assembleDebug -x test`：BUILD SUCCESSFUL（1m54s）
- `./gradlew :app:assembleRelease -x test`：BUILD SUCCESSFUL（2m43s）
- 本轮修复相关功能已完成静态与编译验证；建议按“搜索→下载→书架→规则编辑→诊断→日志”顺序做一次真机回归。

### 后续计划
- 如需进一步压缩体积，可按业务使用频率裁剪 `material-icons-extended` 依赖（替换为按需图标导入策略）。
- 阅读器（Phase 5）继续保留分支延期策略，单独推进高风险迁移。

---

## 2026-02-27 23:59:00

### 实现目标
- 修复下载模式下条目刷新异常，保证日志开启后屏幕可见；导出改为系统 Download；首页进界面自动刷书源并统一并发配置；书源状态改为红/绿点。

### 变更内容
- `ui/viewmodels/SearchDownloadViewModel.kt`
  - 下载任务新增属性变更监听（`attachTaskListener`），任务进度/状态变更会实时触发列表刷新，修复“下载条目不正常/不更新”。
  - 新增 `refreshSourceHealthOnceOnScreenEnter()`，用于首页进入时自动完整刷新书源健康状态。
  - 书源健康检查并发改为读取配置 `aggregateSearchMaxConcurrency`，并限制上限 10，按分块执行。
- `ui/compose/screens/SearchScreen.kt`
  - 进入页面自动触发一次书源健康刷新。
  - 书源下拉与当前选择改为彩色状态点展示（成功绿点、失败红点、未知灰点），不再使用黑色符号。
- `ui/viewmodels/MainViewModel.kt`
  - `setStatusMessage` 同步写入 `AppLogger`，日志开启时能稳定看到屏幕交互链路日志，便于排错。
- `domain/models/AppSettings.kt`
  - 默认并发调整为：`maxConcurrency=10`、`aggregateSearchMaxConcurrency=10`。
- `ui/viewmodels/SettingsViewModel.kt`
  - 默认并发字段与模型默认值对齐为 10。
  - 导出日志/数据库改为落地系统 Download（`ReadStorm` 子目录），不再停留在应用私有目录。
- `infrastructure/services/WorkDirectoryManager.kt`
  - 新增 `exportToPublicDownloads(...)`：Android 10+ 使用 MediaStore 写入系统 Download；低版本写入公共下载目录。
- `ui/viewmodels/BookshelfViewModel.kt`
  - TXT/EPUB 导出后同步复制到系统 Download/ReadStorm，便于其他程序直接访问。

### 验证结果
- `./gradlew :app:assembleDebug -x test`：BUILD SUCCESSFUL（7s）
- `./gradlew :app:assembleRelease -x test`：BUILD SUCCESSFUL（1m9s）
- 二次回归编译：`./gradlew :app:assembleDebug -x test`：BUILD SUCCESSFUL（6s）

### 后续计划
- 如需进一步提高下载列表性能，可将任务监听刷新从“每次属性变化”升级为节流刷新（如 200ms 批量合并）。
- 可在设置页增加“书源健康刷新并发”独立选项（当前与搜索并发一致）。
