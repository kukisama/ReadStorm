# ReadStorm 执行进度

> 目标区间：M1 -> M1.5（由 Copilot 持续自主推进）
> 更新时间：2026-02-16

## 当前基线

- 已完成：
  - 分层 solution 与 Avalonia UI 壳
  - 全量书源规则加载与切换
  - 真实规则搜索（含 fallback）
  - 设置 JSON 持久化
  - 下载任务状态机模型
- 构建状态：`dotnet build ReadStorm.slnx` 通过
- 测试状态：`dotnet test ReadStorm.slnx --no-build` 通过（6/6）

## 当前正在执行

1. 实现目录解析（Toc）
2. 实现章节抓取（Chapter）
3. 打通真实下载最小闭环（先 TXT）

## 阶段进展（2026-02-16 第二次更新）

- 已完成 `RuleBasedDownloadBookUseCase`：
  - 规则驱动目录解析（含分页/offset/desc）
  - 章节正文抓取（含分页）
  - 正文基础清洗（换行标准化 + rule.filterTxt）
  - TXT 导出（输出路径来自用户设置）
- 下载任务状态已与真实下载流程联动：
  - `Queued -> Downloading -> Succeeded/Failed/Cancelled`
  - 进度按章节推进，完成后写入 `OutputFilePath`
  - 失败时写入 `Error`
- UI 下载任务页已展示：状态、进度、输出路径、错误信息
- DI 已将下载用例切换为真实实现：`IDownloadBookUseCase -> RuleBasedDownloadBookUseCase`

## 阶段进展（2026-02-16 第三次更新）

- 多源稳定性增强：
  - `RuleBasedSearchBooksUseCase` 增加 HTTP 重试退避（3 次，指数退避）
  - `RuleBasedDownloadBookUseCase` 增加 HTTP 重试退避（3 次，指数退避）
  - 统一请求克隆机制，兼容 POST 表单重试
- 集成/行为测试补齐：
  - 新增“自定义规则目录加载”测试
  - 新增“下载状态机非法流转保护”测试
- 自动化测试数量提升到 8 条，全部通过

## 阶段进展（2026-02-16 第四次更新）

- 已补“下载闭环固定夹具集成测试”（无外网依赖）：
  - 本地规则目录 + 假 HTTP 响应 + 真实下载用例
  - 验证目录解析、章节抓取、正文清洗、TXT 导出
- 下载错误可视化增强：
  - `DownloadErrorKind`（Network/Rule/Parse/IO/Cancelled/Unknown）
  - UI 可直接显示错误类型
- 下载链路/搜索链路均已具备请求重试退避能力（3 次指数退避）
- 自动化测试数量提升到 9 条，全部通过

## 阶段进展（2026-02-16 第五次更新）

- 修复发布版“找不到书源规则文件”问题：
  - 新增统一规则路径解析器 `RulePathResolver`
  - 不再依赖固定上级层级推导，改为多候选目录自动探测
- 修复发布打包策略：
  - 发布时优先打包参考项目全量规则（1~20）到 `publish/rules/`
  - 若参考目录不存在，自动回退到本地规则样例
- 产物验证：`publish/rules/` 现已包含 `rule-1.json` 到 `rule-20.json`
- 构建 + 测试 + 发布已全部通过

## 阶段进展（2026-02-16 第六次更新）

- 修复“书源下拉空白”问题：
  - `EmbeddedRuleCatalogUseCase` 对异常规则文件（如数组结构 JSON）改为跳过而非中断
- 修复“指定书源下载目录为空”的误导链路：
  - `HybridSearchBooksUseCase` 在“指定书源”时不再回退 mock 搜索结果
  - 避免生成 `example.com` 假链接导致后续下载失败
- 构建与测试恢复全绿：9/9

## 阶段进展（2026-02-16 第七次更新）

- 针对“可搜索但真实下载失败”新增下载诊断日志（高密度）：
  - 下载开始/结束、书源与规则加载、目录抓取、章节抓取、分页、重试、导出结果
  - 失败时将“最近诊断片段”回填到任务错误信息，便于 UI 直接观察
- 新增持久化日志文件：
  - 默认路径：`publish/logs/readstorm-download.log`
  - 即使 WinExe 无控制台，也可直接打开文件排错
- UI 状态栏补充日志定位信息：
  - 下载成功/失败后都会显示日志文件路径
- 回归验证：
  - `dotnet test tests/ReadStorm.Tests/ReadStorm.Tests.csproj` 通过（9/9）

## 阶段进展（2026-02-16 第八次更新）

- 修复“下载成功但 UI 显示怪异（错误类型 None / 无中间态）”：
  - `IDownloadBookUseCase` 改为“传入并原位更新任务对象”，不再仅返回最终态
  - `DownloadTask` 增加属性变更通知（INotifyPropertyChanged），支持实时刷新状态与进度
  - `MainWindowViewModel` 改为先入队再执行下载，UI 可观察 Queued -> Downloading -> Succeeded/Failed
  - 任务卡片错误展示改为友好文案（成功时不再显示“错误类型：None”）
- 兼容回归：
  - 单测/集成测试已同步接口并通过（9/9）
  - 已重新发布到 `src/ReadStorm.Desktop/bin/Release/net10.0/win-x64/publish`

## M1.5 里程碑判定

已满足 M1.5 进入条件：

1. 真实下载闭环已实现（搜索 -> 目录 -> 章节 -> TXT 导出）
2. 多源稳定性已增强（重试退避 + 规则兼容改进）
3. 自动化验证可复现（构建通过 + 9 条测试通过）
4. 关键失败信息可诊断（Error + ErrorKind）

## 验证结果

- 构建：`dotnet build ReadStorm.slnx` ✅
- 测试：`dotnet test ReadStorm.slnx --no-build` ✅（6/6）

## 下一步

1. 开始 M2 前置：抽离阅读器数据模型（books / reading_progress）
2. 下载完成自动入书架（元信息落库）
3. 准备 TXT 阅读页最小可用版本（打开/分页/进度保存）

## 下一里程碑（短期）

- 里程碑：单书源真实 TXT 下载成功（可在 UI 路径触发）
- 验收：
  - 搜索结果可拿到书籍 URL
  - 可解析章节目录
  - 可抓取章节正文并写出 TXT
  - 任务状态与进度可联动
