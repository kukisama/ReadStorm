# 变更计划（Desktop + Android）

> 创建时间：2026-02-21  
> 目标：针对阅读分页模型、启动首屏、书架进度条、日志与数据库导出、阅读页网页入口移除，先完成跨端可执行方案设计。

## 1. 问题理解与边界

本次为**跨端大改动规划**，涉及 `ReadStorm.Desktop` 与 `ReadStorm.Android`，暂不直接落地代码实现，先输出可执行计划。

### 明确需求（按优先级）
1. 阅读章节显示改为**纯翻页模式**：不再允许下拉滚动。
2. 刘海侵入后，刘海区域只用于背景延展，**不显示文字**。
3. 页面显示行数采用**整行截断**：例如“14.5 行”只显示 14 行，半行不显示，剩余到下一页。
4. 每章开头先显示**原始章节标题（居中）**，然后空一行，再开始正文。
5. 章节翻页边界需连续：
   - 到当前章节末页后再次点击右侧翻页，直接进入下一章首页；
   - 在章节首页点击左侧翻页，直接回到上一章末页。
6. 首页白屏问题继续攻关，确保启动时稳定显示 Logo/启动图。
7. 书架下载进度条视觉越界：需严格收敛在容器内（左右至少留白 5px）。
8. 诊断日志新增设置开关（默认关闭）+ 导出能力（Android 需权限策略）。
9. 书库数据库支持完整导出（Android 需权限策略）。
10. 增加设置项：应用启动时自动检测未完成下载并自动续传/更新（Desktop + Android 同步逻辑），默认**关闭**。
11. 阅读页面“打开网页”功能暂时移除。

### 不在本轮直接改动范围
- 不做 Domain 大规模重构。
- 不引入新的复杂三方 UI 组件库。
- 不改变现有核心下载业务链路。

---

## 2. 方案总览（MVP）

### MVP-A：阅读引擎从“滚动视口”切到“离散分页”
- 核心思想：在字体、行高、段距确定后，计算每页可容纳**完整行数 N**，按章节文本切片为固定页序列。
- 结果：章节总页数固定，前后翻页只在页索引上跳转，不再依赖 ScrollViewer 偏移。

### MVP-B：刘海安全显示区与内容显示区解耦
- 视觉层：背景可侵入刘海。
- 内容层：正文渲染区域下移到“安全文本起始线”后再排版。
- 结果：刘海区无字符，视觉统一且不会遮挡文本。

### MVP-C：启动首屏改为“系统级 + 应用级双保险”
- 系统启动主题负责冷启动阶段。
- 应用首帧阶段保留可控遮罩，直到首屏关键资源就绪才切换。
- 结果：减少/消除白屏闪烁，Logo 稳定可见。

---

## 3. 分阶段实施计划

## Phase 0（P0）阅读分页模型重构（Desktop + Android）

### 目标
- 从“可滚动阅读”切换为“纯翻页阅读”。

### 任务拆解
1. 在阅读 ViewModel 引入分页模型（`ChapterPages`、`CurrentPageIndex`、`TotalPages`）。
2. 引入“文本排版测量”步骤：
   - 计算可用高度 = 视口高度 - 顶部安全文本区 - 底部工具栏保留区。
   - 计算理论行数，取 `floor()` 得到整行容量。
3. 章节文本按行容量切页：
   - 仅输出完整行；
   - 半行内容延迟到下一页。
4. 每章首页结构统一为：
   - 第 1 行：章节标题（原始标题，水平居中）；
   - 第 2 行：空行；
   - 第 3 行起：正文内容。
5. 翻页命令统一（上一页/下一页），禁用下拉滚动交互。
6. 跨章节翻页边界处理：
   - 章节末页继续向后翻：直接进入下一章首页；
   - 章节首页向前翻：直接进入上一章末页。

### 验收标准
- 任意分辨率下都不会出现半行。
- 字号/行距变化后，章节页数重新计算且稳定。
- 滑动不再触发内容位移，仅保留翻页路径。
- 每章首页可见“居中标题 + 空一行 + 正文”结构，且标题使用原始章节名。
- 在章节边界连续翻页时无卡顿/无空白页，前后章衔接正确。

---

## Phase 1（P0）刘海侵入与文本安全区（Android 优先，Desktop 同步语义）

### 目标
- 背景侵入刘海，但文本永不进入刘海区。

### 任务拆解
1. 明确“背景区域”与“文本安全区域”两个 Insets 概念。
2. 文本排版以安全区起点为起始基线（可配置一个最小额外留白）。
3. 与分页模型联动：可用行数计算必须基于文本安全区。

### 验收标准
- 刘海区域无正文字符。
- 开/关“侵入刘海”时分页稳定，不出现抖动与错页。

---

## Phase 2（P0）启动白屏治理（Android）

### 目标
- 冷启动阶段稳定显示 Logo/启动图，不出现明显白屏。

### 任务拆解
1. 复核并收敛启动主题链路（Android 12+ 与 12-）。
2. 校验启动资源可访问性与尺寸适配（避免拉伸/裁切异常）。
3. 增加应用首屏就绪判定（首屏 VM + 关键控件渲染完成）后再移除遮罩。
4. 用低端机/真机做冷启动回归验证。

### 验收标准
- 冷启动可见 Logo，白屏时间显著下降或不可感知。
- 多次冷启动结果稳定一致。

---

## Phase 3（P1）书架进度条视觉修复（Desktop + Android）

### 目标
- 进度条始终位于卡片容器内，左右留白 >= 5px。

### 任务拆解
1. 统一卡片内容宽度与进度条宽度计算规则。
2. 增加内边距与最大宽度约束，防止 100% 文本和条形产生“突出容器”观感。
3. 双端视觉回归（不同 DPI、字体缩放）。

### 验收标准
- 0%/50%/100% 三状态均不越界。
- 不同书名长度下布局稳定。

---

## Phase 4（P1）日志开关与导出（Desktop + Android）

### 目标
- 诊断日志默认关闭，支持手动开启与导出。

### 任务拆解
1. 设置页新增 `EnableDiagnosticLog` 开关（默认 `false`），持久化。
2. 日志采集入口统一受开关控制（关闭时仅保留必要错误日志）。
3. 增加导出命令：生成带时间戳的日志文件。
4. Android 导出路径策略：优先应用专属外部目录；如导出到公共目录，再按 API 版本申请/处理权限。

### 验收标准
- 默认安装后日志开关为关闭。
- 导出可成功落盘并可被用户访问。

---

## Phase 5（P1）书库数据库完整导出（Desktop + Android）

### 目标
- 支持一键导出书库数据库（完整文件）。

### 任务拆解
1. 明确数据库文件定位（含 WAL/SHM 协调策略）。
2. 导出前处理并发写入（短时锁/快照拷贝策略）。
3. 导出 UI 与错误反馈（路径、权限、文件占用）。
4. Android 权限与路径策略与日志导出统一。

### 验收标准
- 导出文件可用于恢复验证（后续可补“导入校验”）。
- 导出失败时有明确错误提示。

---

## Phase 6（P1）启动自动续传/更新开关（Desktop + Android）

### 目标
- 为“应用启动后自动检测未完成下载并自动续传/更新”提供可控开关，默认关闭。

### 任务拆解
1. 在设置模型与设置页新增开关字段（建议命名：`AutoResumeAndRefreshOnStartup`），默认值 `false`。
2. 启动流程增加条件触发：
   - 开关关闭：不自动触发续传/更新；
   - 开关开启：启动后在后台触发“未完成任务检测 + 续传/更新”。
3. Desktop 与 Android 共用同一业务入口，避免平台行为不一致。
4. 增加防重入与并发保护，避免启动阶段重复触发。

### 验收标准
- 新安装与旧配置迁移后，默认状态均为关闭。
- 开关关闭时，应用启动不会自动续传/更新。
- 开关开启时，应用启动后会自动执行一次检测并触发续传/更新。
- Desktop 与 Android 行为一致。

---

## Phase 7（P2）移除阅读页“打开网页”入口（Desktop + Android）

### 目标
- 临时下线无效功能，避免误导用户。

### 任务拆解
1. 移除阅读页按钮/菜单入口及事件绑定。
2. 保留后端能力（如有）但不暴露 UI。
3. 同步清理相关提示文案与快捷键。

### 验收标准
- 阅读页不再出现“打开网页”入口。
- 无空事件或无效命令残留。

---

## 4. 影响范围

- UI 层：`src/ReadStorm.Android/Views/*`、`src/ReadStorm.Desktop/Views/*`
- 交互层：对应 `*.axaml.cs`
- VM 层：重点 `ReaderViewModel`、设置与日志相关 VM
- 基础设施层：日志导出/数据库导出服务
- 文档：`docs/变更日志.md`（每阶段落地后追加）

---

## 5. 风险与缓解

1. **分页算法稳定性风险**（不同字体/分辨率）
   - 缓解：建立固定样例章节回归集，逐设备对比页数一致性。
2. **Android 权限碎片化风险**
   - 缓解：采用“应用专属目录优先，公共目录可选授权”策略。
3. **启动首屏机型差异风险**
   - 缓解：覆盖 Android 12+ 与旧系统两条主题链路回归。

---

## 6. 建议实施顺序

优先级建议：
1. `Phase 0 + Phase 1`（阅读核心体验）
2. `Phase 2`（启动白屏）
3. `Phase 3`（书架视觉）
4. `Phase 4 + Phase 5`（导出能力）
5. `Phase 6`（自动续传/更新开关）
6. `Phase 7`（移除无效入口）

> 说明：分页模型是后续所有阅读行为的基础，建议先完成并稳定后，再做其余功能并行改造。

---

## 7. 阶段复盘与第二阶段补完计划（2026-02-21）

> 说明：以下为用户验收反馈中确认“尚未达标”的项，当前仅记录计划，不进行代码修改。

### 7.1 未完成项确认（来自验收反馈）
1. **启动首屏仍有白屏，Logo 出现过晚**
   - 现象：首次进入仍有明显白屏，Logo 位置与出现时机不符合预期。
2. **Android App 图标未替换为指定素材（png/ico）**
   - 要求：无论 Debug 还是 Release 包，均应使用指定图标资产。
3. **导出目标路径不符合平台规范**
   - Windows：导出诊断日志/数据库时应弹出“用户选择保存位置”对话框。
   - Android：应处理权限并导出到用户手机可访问的 `ReadStorm` 目录（而非应用当前目录）。
4. **Android 书架下载进度条仍越界**
   - 现象：进度条贴近/侵入书籍卡片边缘与卡片间隙，视觉上“顶满容器”。
   - 预期：进度条显示宽度上限约为卡片内容区的 **2/3**，并保持明确左右留白。
5. **Android 阅读页“点击左/右三分之一翻页”基本不可用**
   - 现象：左右滑动翻页勉强可用，但点击左/右三分之一区域触发率低，实际近似不可用。
   - 预期：点击左/右三分之一区域应稳定触发上一页/下一页，且与滑动手势不冲突。
6. **阅读页底部出现“半行被状态条遮挡”问题（Desktop + Android）**
   - 现象：分页按理想行高算满后，底部最后一行偶发被黑色状态条压住（半行可见）。
   - 根因线索：未预留底部状态栏高度，段距/字框占高估算偏乐观，`floor` 容量计算在边界场景失真。
   - 预期：采用“保守分页”策略，彻底避免半行遮挡。
7. **Android 刘海侵入后顶部安全区行高不足（字符贴近刘海）**
   - 现象：Desktop 表现正常，但 Android 开启顶部侵入后，正文首行与刘海/状态栏区域距离不足，存在贴边观感。
   - 预期：Android 端文本安全区至少预留一整行高度（可理解为“空一行”），确保字符不触碰刘海区域。

### 7.2 第二阶段计划（Phase 8 ~ Phase 14）

## Phase 8（P0）启动首屏与 Logo 时序补完（Android）

### 目标
- 消除首次白屏感知，确保 Logo 在冷启动链路中前置且稳定可见。

### 任务拆解
1. 复核 Splash 主题、窗口背景、首帧遮罩三段时序的衔接点。
2. 调整“移除遮罩”触发条件：从单一 Loaded 事件升级为“关键 UI + VM 数据就绪”双条件。
3. 对首帧过渡增加最短展示阈值与最大超时兜底，避免闪烁或卡住。
4. 在真机冷启动多轮回归，记录白屏时长区间。

### 验收标准
- 冷启动期间可稳定看到 Logo，白屏不可感知或显著下降。
- 连续多次冷启动结果一致，无偶发回退。

---

## Phase 9（P0）Android 应用图标资产链路补完（Debug + Release）

### 目标
- 指定图标素材在 Android Debug/Release 全配置生效。

### 任务拆解
1. 梳理 Android 图标来源链路（`mipmap` / `android:icon` / `android:roundIcon` / MAUI/Avalonia 资源映射）。
2. 统一图标资源输入格式与尺寸（前景/背景或自适应图标方案）。
3. 明确 Debug、Release 的资源包含与覆盖规则，避免仅一侧生效。
4. 构建并安装双配置包做设备端校验。

### 验收标准
- Debug 与 Release 安装后图标一致且为指定素材。
- 不出现旧图标缓存导致的回退（提供复验步骤）。

---

## Phase 10（P0）导出交互与路径规范补完（Desktop + Android）

### 目标
- 导出日志/数据库遵循平台交互与用户可访问路径规范。

### 任务拆解
1. Windows：日志导出、数据库导出均改为“用户选择保存位置”流程。
2. Android：导出前处理运行时权限，导出目标为用户可见的手机 `ReadStorm` 目录。
3. 统一导出成功/失败反馈（路径、权限被拒绝、占用冲突）。
4. 对 WAL/SHM 协调与失败回滚策略补充说明。

### 验收标准
- Windows 不再默认写入应用当前目录，必须由用户选择导出路径。
- Android 导出后可在手机文件管理器中直接看到 `ReadStorm` 目录下文件。

---

## Phase 11（P0）Android 书架进度条容器约束修复

### 目标
- 修复进度条侵占卡片边缘与卡片间隙的问题，收敛视觉层级。

### 任务拆解
1. 先做布局成因排查：卡片内外边距、进度条容器宽度绑定、父容器对齐策略、百分比文本挤压影响。
2. 建立进度条最大宽度规则：不超过卡片内容区 **2/3**，并固定左右安全留白。
3. 拆分“信息区（书名/作者）”与“进度区”布局，防止条形撑满外层容器。
4. 在不同字体缩放与 DPI 下做视觉回归截图对比。

### 验收标准
- Android 端进度条不触碰卡片边界，不侵入卡片间距区域。
- 0%/50%/100% 与长书名场景均稳定。

---

## Phase 12（P0）Android 点击热区翻页可用性修复

### 目标
- 修复阅读页“点击左/右三分之一翻页”触发不稳定问题，恢复单击翻页主路径可用性。

### 任务拆解
1. 排查点击命中链路：`Tapped` 事件绑定对象、命中测试层级、遮罩/底部状态栏是否吞事件。
2. 校验热区计算基准：以**内容容器可见宽度**而非全屏宽度计算三分区，避免偏移导致误判。
3. 明确手势仲裁：单击翻页与左右滑动手势冲突时，优先保证单击触发一致性与可预测性。
4. 增加调试日志（仅开发态）记录点击坐标、命中区域、执行命令，便于真机复验。

### 验收标准
- Android 真机上，点击左/右三分之一区域可稳定触发上一页/下一页。
- 与滑动翻页共存时不出现“双触发”或“吞点击”现象。
- 连续点击翻页场景下无明显卡顿与失灵。

---

## Phase 13（P0）阅读页保守分页防遮挡修复（Desktop + Android）

### 目标
- 解决底部半行被遮挡问题，保证分页结果只出现完整行。

### 任务拆解
1. 分页可用高度改为：`viewportHeight - ReaderContentMargin.Top - ReaderContentMargin.Bottom - BottomStatusBarReserve`。
2. 引入有效行高：`effectiveLineHeight = max(ReaderLineHeight, ReaderFontSize * k)`（`k` 作为可调系数）。
3. 引入“1.5 倍规则”进行末行判定：
   - 若剩余高度 `< 1.5 × effectiveLineHeight`：不再显示下一行；
   - 若剩余高度 `>= 1.5 × effectiveLineHeight`：允许显示 1 行。
4. 段落估算联动 `ParagraphMargin` 与字框占高，避免仅按字符数估算导致的边界溢出。
5. Desktop/Android 统一分页参数来源与回归样例，确保跨端行为一致。

### 验收标准
- 任意字号/行距/段距组合下，正文末行不再被底部状态条遮挡。
- 不出现“半行可见”与“触底后抖动重排”。
- Desktop 与 Android 分页表现一致（同章节同配置下页数波动在可接受范围内）。

---

## Phase 14（P0）Android 刘海顶部文本安全行修复

### 目标
- 在 Android 开启刘海侵入时，确保正文与刘海区域保持可感知安全间距（至少一整行高度）。

### 任务拆解
1. 明确 Android 文本安全区起始线计算，不再仅依赖通用 margin。
2. 新增“顶部安全行预留”参数：最小值为 `effectiveLineHeight`（至少空一行）。
3. 分页可用高度联动顶部安全行，避免仅视觉下移而分页容量未同步造成错页。
4. 对不同系统版本与不同状态栏/刘海高度机型做真机回归。

### 验收标准
- Android 端开启刘海侵入后，正文首行不触碰刘海/状态栏区域。
- 至少保留一整行的顶部安全留白（视觉等价“空一行”）。
- Desktop 行为不回退，不引入额外留白异常。

---

### 7.3 第二阶段建议执行顺序
1. `Phase 8`（启动白屏与 Logo）
2. `Phase 9`（Android 图标）
3. `Phase 10`（导出交互与路径）
4. `Phase 11`（Android 进度条约束）
5. `Phase 12`（Android 点击热区翻页可用性）
6. `Phase 13`（阅读页保守分页防遮挡）
7. `Phase 14`（Android 刘海顶部文本安全行）

> 备注：`Phase 8/10/11/12/13/14` 为用户感知最强的体验问题，建议优先并尽快进入实施。