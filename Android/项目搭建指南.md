# ReadStorm Android 项目搭建指南

> 本文档提供 Android 项目从零搭建到模拟器运行的完整步骤。面向实际操作，可作为开发 Checklist 使用。

---

## 一、前置条件

### 1.1 开发环境

| 工具 | 版本要求 | 安装方式 |
|------|---------|---------|
| .NET SDK | 10.0+ | https://dotnet.microsoft.com/download |
| JDK | 17+ | `apt install openjdk-17-jdk` 或 https://adoptium.net |
| Android SDK | API 31+ | 通过 Android Studio 或命令行安装 |
| Android workload | 最新 | `dotnet workload install android` |

### 1.2 验证环境

```bash
# 验证 .NET 版本
dotnet --version
# 应输出 10.0.x

# 验证 Android workload
dotnet workload list
# 应显示 android

# 验证 JDK
java -version
# 应显示 17+
```

---

## 二、创建 Android 项目

### 步骤 1：创建项目目录

```bash
mkdir -p src/ReadStorm.Android/Resources/drawable
mkdir -p src/ReadStorm.Android/Resources/values
```

### 步骤 2：创建项目文件

创建 `src/ReadStorm.Android/ReadStorm.Android.csproj`：

```xml
<Project Sdk="Microsoft.NET.Sdk">
  <PropertyGroup>
    <TargetFramework>net10.0-android</TargetFramework>
    <OutputType>Exe</OutputType>
    <ApplicationId>com.readstorm.app</ApplicationId>
    <ApplicationVersion>1</ApplicationVersion>
    <ApplicationDisplayVersion>1.0.0</ApplicationDisplayVersion>
    <SupportedOSPlatformVersion>21</SupportedOSPlatformVersion>
    <Nullable>enable</Nullable>
    <ImplicitUsings>enable</ImplicitUsings>
  </PropertyGroup>

  <ItemGroup>
    <PackageReference Include="Avalonia" Version="11.3.11" />
    <PackageReference Include="Avalonia.Android" Version="11.3.11" />
    <PackageReference Include="Avalonia.Themes.Fluent" Version="11.3.11" />
    <PackageReference Include="Avalonia.Fonts.Inter" Version="11.3.11" />
    <PackageReference Include="CommunityToolkit.Mvvm" Version="8.2.1" />
    <PackageReference Include="Microsoft.Extensions.DependencyInjection" Version="10.0.0" />
    <PackageReference Include="Semi.Avalonia" Version="11.2.1" />
  </ItemGroup>

  <ItemGroup>
    <ProjectReference Include="..\ReadStorm.Application\ReadStorm.Application.csproj" />
    <ProjectReference Include="..\ReadStorm.Infrastructure\ReadStorm.Infrastructure.csproj" />
  </ItemGroup>
</Project>
```

### 步骤 3：创建 Android 入口

创建 `src/ReadStorm.Android/MainActivity.cs`：

```csharp
using Android.Content.PM;
using Avalonia;
using Avalonia.Android;

namespace ReadStorm.Android;

[Activity(
    Label = "ReadStorm",
    Theme = "@style/MyTheme.NoActionBar",
    Icon = "@drawable/icon",
    MainLauncher = true,
    ConfigurationChanges = ConfigChanges.Orientation
        | ConfigChanges.ScreenSize
        | ConfigChanges.UiMode)]
public class MainActivity : AvaloniaMainActivity<App>
{
    protected override AppBuilder CustomizeAppBuilder(AppBuilder builder)
    {
        return base.CustomizeAppBuilder(builder)
            .WithInterFont()
            .LogToTrace();
    }
}
```

> **注意**：这里的 `App` 类引用的是 `ReadStorm.Desktop.App`，需在 `using` 中添加 `using ReadStorm.Desktop;` 或在 csproj 中引用 Desktop 项目。
>
> 更好的做法是将 `App` 类提取到共享位置，或者在 Android 项目中创建自己的 `App` 类（继承同样的初始化逻辑）。

### 步骤 4：创建 AndroidManifest.xml

创建 `src/ReadStorm.Android/AndroidManifest.xml`：

```xml
<?xml version="1.0" encoding="utf-8"?>
<manifest xmlns:android="http://schemas.android.com/apk/res/android">
    <uses-permission android:name="android.permission.INTERNET" />
    <uses-permission android:name="android.permission.ACCESS_NETWORK_STATE" />

    <application
        android:label="ReadStorm"
        android:icon="@drawable/icon"
        android:usesCleartextTraffic="true"
        android:theme="@style/MyTheme.NoActionBar">
    </application>
</manifest>
```

### 步骤 5：创建 Android 主题样式

创建 `src/ReadStorm.Android/Resources/values/styles.xml`：

```xml
<?xml version="1.0" encoding="utf-8" ?>
<resources>
    <style name="MyTheme" parent="@android:style/Theme.Material.Light">
    </style>
    <style name="MyTheme.NoActionBar" parent="MyTheme">
        <item name="android:windowNoTitle">true</item>
        <item name="android:windowActionBar">false</item>
    </style>
</resources>
```

### 步骤 6：添加应用图标

将应用图标放置到 `src/ReadStorm.Android/Resources/drawable/icon.png`。

> 可暂时使用任意 PNG 图标作为占位符，后续替换为正式 Logo。

### 步骤 7：更新解决方案文件

编辑 `ReadStorm.slnx`，添加 Android 项目：

```xml
<Solution>
  <Folder Name="/src/">
    <Project Path="src/ReadStorm.Application/ReadStorm.Application.csproj" />
    <Project Path="src/ReadStorm.Desktop/ReadStorm.Desktop.csproj" />
    <Project Path="src/ReadStorm.Domain/ReadStorm.Domain.csproj" />
    <Project Path="src/ReadStorm.Infrastructure/ReadStorm.Infrastructure.csproj" />
    <Project Path="src/ReadStorm.Android/ReadStorm.Android.csproj" />
  </Folder>
  <Folder Name="/tests/">
    <Project Path="tests/ReadStorm.Tests/ReadStorm.Tests.csproj" />
  </Folder>
</Solution>
```

---

## 三、修改现有代码以支持移动端

### 3.1 修改 App.axaml.cs

在 `OnFrameworkInitializationCompleted` 方法中添加移动端生命周期支持：

```csharp
public override void OnFrameworkInitializationCompleted()
{
    DisableAvaloniaDataAnnotationValidation();
    _serviceProvider = ConfigureServices();

    var mainViewModel = _serviceProvider.GetRequiredService<MainWindowViewModel>();

    if (ApplicationLifetime is IClassicDesktopStyleApplicationLifetime desktop)
    {
        desktop.MainWindow = new MainWindow
        {
            DataContext = mainViewModel,
        };
        desktop.Exit += (_, _) => _serviceProvider?.Dispose();
    }
    else if (ApplicationLifetime is ISingleViewApplicationLifetime singleView)
    {
        // 移动端使用 UserControl 作为主视图
        singleView.MainView = new MainView { DataContext = mainViewModel };
    }

    base.OnFrameworkInitializationCompleted();
}
```

### 3.2 创建移动端 MainView

创建 `src/ReadStorm.Desktop/Views/MainView.axaml`：

```xml
<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             x:Class="ReadStorm.Desktop.Views.MainView">
    <!-- 移动端主布局 — 后续 UI 适配阶段完善 -->
    <TextBlock Text="ReadStorm Android"
               HorizontalAlignment="Center"
               VerticalAlignment="Center"
               FontSize="24" />
</UserControl>
```

创建对应的 code-behind `src/ReadStorm.Desktop/Views/MainView.axaml.cs`：

```csharp
using Avalonia.Controls;

namespace ReadStorm.Desktop.Views;

public partial class MainView : UserControl
{
    public MainView()
    {
        InitializeComponent();
    }
}
```

---

## 四、构建与运行

### 4.1 构建 Android 项目

```bash
# 构建 Android 项目
dotnet build src/ReadStorm.Android -c Debug

# 如果构建成功，生成 APK 在：
# src/ReadStorm.Android/bin/Debug/net10.0-android/com.readstorm.app-Signed.apk
```

### 4.2 部署到模拟器

```bash
# 启动 Android 模拟器（通过 Android Studio AVD Manager）
# 或使用命令行：
emulator -avd <avd_name>

# 部署并运行
dotnet build src/ReadStorm.Android -t:Install -f net10.0-android
```

### 4.3 确保桌面端不受影响

```bash
# 构建桌面端（验证无回退）
dotnet build src/ReadStorm.Desktop

# 运行测试（验证无回退）
dotnet test ReadStorm.slnx --no-build
```

---

## 五、常见问题排查

### Q1：构建报错 "Android SDK not found"

```bash
# 安装 Android workload
dotnet workload install android

# 如果仍然报错，设置 Android SDK 路径
export ANDROID_HOME=$HOME/Android/Sdk
```

### Q2：构建报错 "JDK not found"

```bash
# 安装 JDK 17
sudo apt install openjdk-17-jdk

# 设置 JAVA_HOME
export JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64
```

### Q3：模拟器上应用闪退

检查以下几项：
1. `AndroidManifest.xml` 中是否声明了 `INTERNET` 权限
2. `SupportedOSPlatformVersion` 是否不高于模拟器 API 版本
3. 查看 logcat 日志：`adb logcat | grep ReadStorm`

### Q4：SSL/TLS 连接失败

部分书源使用 HTTP，Android 9+ 默认阻止明文流量。确保 `AndroidManifest.xml` 中设置了：

```xml
android:usesCleartextTraffic="true"
```

### Q5：无法读写本地文件

Android 文件系统权限比桌面端更严格：
- 应用私有数据使用 `Environment.GetFolderPath(Environment.SpecialFolder.LocalApplicationData)`
- 共享存储需申请 `READ_EXTERNAL_STORAGE` / `WRITE_EXTERNAL_STORAGE` 权限（Android 13+ 使用媒体权限）

---

## 六、搭建完成 Checklist

- [ ] .NET 10 SDK 已安装
- [ ] JDK 17+ 已安装
- [ ] Android workload 已安装（`dotnet workload install android`）
- [ ] `src/ReadStorm.Android/` 目录已创建
- [ ] `ReadStorm.Android.csproj` 已配置
- [ ] `MainActivity.cs` 已编写
- [ ] `AndroidManifest.xml` 已配置
- [ ] `styles.xml` 已创建
- [ ] 应用图标已放置
- [ ] `ReadStorm.slnx` 已更新
- [ ] `App.axaml.cs` 已添加移动端分支
- [ ] `MainView.axaml` 已创建
- [ ] Android 项目构建成功
- [ ] 桌面端构建未受影响
- [ ] 现有测试全部通过
