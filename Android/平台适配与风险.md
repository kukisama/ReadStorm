# ReadStorm Android 平台适配与风险应对

> 本文档讨论 Android 平台特有的技术适配问题，以及可能遇到的风险与应对策略。

---

## 一、平台特定适配项

### 1.1 文件系统路径

| 场景 | 桌面端路径 | Android 路径 |
|------|-----------|-------------|
| 应用数据（SQLite） | `%APPDATA%/ReadStorm/` 或 `~/.readstorm/` | `/data/data/com.readstorm.app/files/` |
| 缓存文件 | 同上 + `cache/` | `/data/data/com.readstorm.app/cache/` |
| 导出文件 | `~/Documents/ReadStorm/` | `/storage/emulated/0/Download/` 或私有目录 |
| 书源规则 | 运行时目录 + `rules/` | 嵌入资源（Assembly Resource） |

**适配方案**：

使用 `Environment.GetFolderPath()` 获取跨平台兼容路径：

```csharp
// 跨平台兼容路径
var appData = Environment.GetFolderPath(Environment.SpecialFolder.LocalApplicationData);
var dbPath = Path.Combine(appData, "ReadStorm.db");
```

### 1.2 书源规则文件加载

桌面端通过 `CopyToOutputDirectory` 将 JSON 规则文件复制到输出目录。Android 端推荐使用**嵌入资源**方式（当前 `EmbeddedRuleCatalogUseCase` 已支持此模式），无需额外修改。

### 1.3 网络安全配置

Android 9 (API 28)+ 默认禁止 HTTP 明文流量。由于大量书源使用 HTTP，需在 `AndroidManifest.xml` 中显式允许：

```xml
<application android:usesCleartextTraffic="true" />
```

如需更精细控制，可使用 `network_security_config.xml`：

```xml
<!-- res/xml/network_security_config.xml -->
<network-security-config>
    <base-config cleartextTrafficPermitted="true" />
</network-security-config>
```

### 1.4 屏幕方向与生命周期

```xml
<!-- AndroidManifest.xml / Activity 属性 -->
ConfigurationChanges = ConfigChanges.Orientation
    | ConfigChanges.ScreenSize
    | ConfigChanges.UiMode
```

- **横竖屏切换**：通过 `ConfigurationChanges` 阻止 Activity 重建，由 Avalonia 框架处理布局重排
- **后台切换**：Avalonia Android 自动处理 `OnPause/OnResume`，ViewModel 状态在内存中保持
- **进程回收**：Android 可能在低内存时杀死后台应用，需定期保存阅读进度

---

## 二、与桌面端的差异及处理

| 差异点 | 桌面端行为 | Android 端行为 | 处理方式 |
|--------|-----------|---------------|---------|
| 窗口类型 | `Window` | 无窗口概念，全屏 Activity | 使用 `UserControl` 作为 `MainView` |
| 对话框 | 弹出独立窗口 | 无法弹出独立窗口 | 使用叠加面板或全屏导航 |
| 文件选择 | 系统文件对话框 | 需使用 Android SAF（Storage Access Framework） | 通过 `Intent` 调用系统文件选择器 |
| 剪贴板 | `Clipboard.SetTextAsync()` | 需 Android ClipboardManager | Avalonia 已适配，一般可直接使用 |
| 拖放 | `DragDrop` API | 不适用 | 省略或改为其他交互 |
| 窗口大小 | 用户可自由调整 | 固定全屏 | 使用响应式布局 |

---

## 三、风险清单与应对

### 🔴 高风险

| 风险 | 影响 | 概率 | 应对措施 |
|------|------|------|----------|
| Semi.Avalonia 控件在 Android 上表现异常 | UI 显示错乱或崩溃 | 中 | 移动端可回退到 `Avalonia.Themes.Fluent`；或为问题控件覆盖样式 |
| 大 HTML 页面解析导致 OOM | 应用崩溃 | 低 | 限制单次解析的 HTML 大小；使用流式解析 |
| 后台下载被系统杀死 | 下载中断 | 高 | 实现断点续传（已有机制）；考虑使用 Android `ForegroundService` |

### 🟡 中风险

| 风险 | 影响 | 概率 | 应对措施 |
|------|------|------|----------|
| SSL 证书校验失败 | 部分书源无法访问 | 中 | 配置自定义 `HttpClientHandler` 跳过证书验证（仅开发环境） |
| SQLite 并发访问异常 | 数据损坏 | 低 | 已有 `SemaphoreSlim` 保护，无需额外处理 |
| 字体渲染差异 | 中文显示不一致 | 中 | 使用 Android 系统中文字体（Noto Sans CJK）作为回退 |
| Avalonia 触控事件不灵敏 | 滑动翻页体验差 | 中 | 使用 `GestureRecognizer` 替代事件处理；调整触控阈值 |

### 🟢 低风险

| 风险 | 影响 | 概率 | 应对措施 |
|------|------|------|----------|
| 桌面端回退 | 现有功能异常 | 极低 | Android 项目独立编译，不影响桌面端项目配置 |
| 构建时间增长 | 开发效率降低 | 低 | 使用 `dotnet build src/ReadStorm.Android` 单独构建，不影响桌面端 |
| APK 体积过大 | 用户安装意愿降低 | 低 | 使用 `PublishTrimmed=true` 和 `AOT` 减小体积 |

---

## 四、性能基线与优化目标

| 指标 | 目标值 | 优化手段 |
|------|--------|---------|
| 冷启动时间 | < 3 秒 | 延迟初始化非首屏服务 |
| 搜索响应时间 | < 5 秒 | 与桌面端一致（取决于网络） |
| 内存占用 | < 150 MB | 虚拟化列表、图片懒加载 |
| APK 大小 | < 30 MB | AOT + Trimming |
| 电量消耗 | 低 | 限制后台网络请求频率 |

---

## 五、Android 版本兼容性矩阵

| Android 版本 | API Level | 市场份额 | 兼容性 | 备注 |
|-------------|-----------|---------|--------|------|
| 5.0-5.1 | 21-22 | ~1% | ✅ 基础支持 | 最低支持版本 |
| 6.0 | 23 | ~2% | ✅ 完全支持 | 运行时权限 |
| 7.0-7.1 | 24-25 | ~3% | ✅ 完全支持 | |
| 8.0-8.1 | 26-27 | ~5% | ✅ 完全支持 | |
| 9.0 | 28 | ~5% | ✅ 完全支持 | 需配置明文流量 |
| 10 | 29 | ~8% | ✅ 完全支持 | 分区存储 |
| 11 | 30 | ~12% | ✅ 完全支持 | |
| 12-12L | 31-32 | ~15% | ✅ 完全支持 | |
| 13 | 33 | ~20% | ✅ 完全支持 | 细粒度媒体权限 |
| 14 | 34 | ~25% | ✅ 完全支持 | |

设置 `SupportedOSPlatformVersion=21` 可覆盖 99%+ 的 Android 设备。

---

## 六、CI/CD 配置建议

### 6.1 GitHub Actions 工作流

```yaml
name: Android Build
on:
  push:
    paths:
      - 'src/ReadStorm.Android/**'
      - 'src/ReadStorm.Application/**'
      - 'src/ReadStorm.Infrastructure/**'
      - 'src/ReadStorm.Domain/**'
  pull_request:
    paths:
      - 'src/ReadStorm.Android/**'

jobs:
  build-android:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'
      - uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
      - run: dotnet workload install android
      - run: dotnet build src/ReadStorm.Android -c Release
      - uses: actions/upload-artifact@v4
        with:
          name: android-apk
          path: src/ReadStorm.Android/bin/Release/net10.0-android/com.readstorm.app-Signed.apk
```

### 6.2 构建注意事项

- Android 构建需要 JDK 17+，CI 环境需配置
- `dotnet workload install android` 需在每次 CI 运行时执行（或缓存）
- 桌面端 CI 不受影响，可独立触发

---

## 七、发布与分发策略

| 分发方式 | 说明 | 优先级 |
|----------|------|--------|
| **GitHub Release APK** | 上传签名 APK 到 Release 页面，用户直接下载安装 | ⭐ 首选 |
| **蒲公英/fir.im** | 国内应用分发平台，扫码安装 | ⭐ 备选 |
| **Google Play** | 全球最大 Android 应用商店 | 后续考虑 |
| **F-Droid** | 开源应用商店 | 后续考虑 |

首版建议通过 **GitHub Release** 分发 APK，无需商店审核，最快速交付。

---

## 八、总结

Android 平台适配的核心工作量在于：

1. **项目搭建**（~100 行）— 配置 + 入口代码
2. **UI 布局适配**（~300-500 行）— 移动端专用布局
3. **平台差异处理**（~50 行）— 文件路径、权限
4. **体验优化**（~100 行）— 手势、屏幕常亮

业务逻辑层（Domain / Application / Infrastructure / ViewModel）**完全不需要改动**，这是选择方案 A（Avalonia 移动端扩展）的最大价值。
