# ReadStorm 四个核心目录功能说明

> 范围：`src/ReadStorm.Application`、`src/ReadStorm.Domain`、`src/ReadStorm.Infrastructure`、`src/ReadStorm.Desktop`
> 
> 目的：说明各目录职责、相互关系、当前耦合点，并为后续“是否合并目录”提供决策依据。

---

## 1. 总体结构（一句话）

当前是典型的分层结构：

- `Desktop`：界面与交互入口（Avalonia）
- `Application`：用例接口层（端口/抽象）
- `Domain`：核心数据模型层（实体/状态/规则模型）
- `Infrastructure`：具体实现层（HTTP/规则解析/数据库/导出/配置持久化）

依赖方向（当前代码真实状态）：

- `Desktop -> Application + Infrastructure`
- `Infrastructure -> Application + Domain`
- `Application -> Domain`
- `Domain` 不依赖其他项目

---

## 2. `ReadStorm.Domain`（核心模型层）

### 2.1 主要职责

承载业务核心数据结构，不做外部 I/O：

- 下载任务状态与状态机（如 `DownloadTask`、`DownloadTaskStatus`）
- 书籍/章节实体（如 `BookEntity`、`ChapterEntity`）
- 规则模型（如 `BookSourceRule`、`FullBookSourceRule`）
- 设置模型（`AppSettings`）
- 诊断/搜索结果模型（`SourceDiagnosticResult`、`SearchResult`）

### 2.2 目录中典型文件

`src/ReadStorm.Domain/Models`：

- `AppSettings.cs`
- `DownloadTask.cs`
- `BookEntity.cs`
- `ChapterEntity.cs`
- `FullBookSourceRule.cs`
- `SearchResult.cs`

### 2.3 与其他层关系

- 被 `Application`、`Infrastructure`、`Desktop` 间接使用
- 作为统一数据契约，减少层间字段漂移

### 2.4 合并建议

- **不建议合并掉**。
- 原因：`Domain` 是全局模型中心，合并后会让 UI 与实现层模型边界模糊，后续演进成本上升。

---

## 3. `ReadStorm.Application`（用例抽象层）

### 3.1 主要职责

定义业务用例接口（端口），隔离 UI 与实现细节：

`src/ReadStorm.Application/Abstractions`：

- `ISearchBooksUseCase`
- `IDownloadBookUseCase`
- `IAppSettingsUseCase`
- `IRuleCatalogUseCase`
- `IRuleEditorUseCase`
- `ISourceDiagnosticUseCase`
- `ISourceHealthCheckUseCase`
- `IBookshelfUseCase`
- `IBookRepository`

### 3.2 当前特点

- 目前以“接口定义”为主，编排逻辑较少
- 由 `Infrastructure` 提供实现，`Desktop` 通过 DI 使用

### 3.3 与其他层关系

- 向下依赖 `Domain`（接口参数/返回值使用领域模型）
- 向上被 `Desktop` 依赖（只看接口）
- 向下被 `Infrastructure` 实现（适配器）

### 3.4 合并建议

- 若团队规模小、短期快速迭代，可考虑并入 `Infrastructure`（降低项目数）
- 但从长期可维护性看，**建议保留**，因为它是依赖倒置的关键边界

---

## 4. `ReadStorm.Infrastructure`（实现与外部资源层）

### 4.1 主要职责

实现 `Application` 中定义的接口，处理所有外部资源与技术细节：

- 规则加载与路径解析：`RulePathResolver`、`EmbeddedRuleCatalogUseCase`
- 规则编辑：`FileBasedRuleEditorUseCase`
- 搜索/下载：`RuleBasedSearchBooksUseCase`、`RuleBasedDownloadBookUseCase`、`HybridSearchBooksUseCase`
- 健康检查与诊断：`FastSourceHealthCheckUseCase`、`RuleBasedSourceDiagnosticUseCase`
- 持久化：`JsonFileAppSettingsUseCase`、`JsonFileBookshelfUseCase`、`SqliteBookRepository`
- 导出：`EpubExporter`
- 运行数据目录管理：`WorkDirectoryManager`

### 4.2 规则资源（已合并）

- 规则 JSON 现在位于：`src/ReadStorm.Infrastructure/rules`
- `Desktop` 打包时会将规则拷贝到输出目录的 `rules/`

### 4.3 与其他层关系

- 依赖 `Application`（实现接口）和 `Domain`（数据模型）
- 被 `Desktop` 通过 DI 注册并调用

### 4.4 合并建议

- `Infrastructure` 目前已经承担“实现聚合层”角色，继续保留是合理的
- 若后续模块继续增多，可按子域拆分子目录（Search/Download/Persistence/Rules）提升可读性

---

## 5. `ReadStorm.Desktop`（界面与组合根）

### 5.1 主要职责

- Avalonia UI 视图与交互（`Views` / `ViewModels`）
- 组合根（DI 注册）与应用启动（`App.axaml.cs`）
- 将用户操作转换成用例调用

### 5.2 当前关键入口

`src/ReadStorm.Desktop/App.axaml.cs` 中集中注册：

- `ISearchBooksUseCase -> HybridSearchBooksUseCase`
- `IDownloadBookUseCase -> RuleBasedDownloadBookUseCase`
- `IAppSettingsUseCase -> JsonFileAppSettingsUseCase`
- `IRuleCatalogUseCase -> EmbeddedRuleCatalogUseCase`
- `IBookRepository -> SqliteBookRepository`
- 以及其他诊断/规则编辑/书架相关实现

### 5.3 当前特点

- `MainWindowViewModel` 功能集中、体量较大，承担大量流程编排
- UI 与实现层连接主要通过 Application 接口 + DI 完成

### 5.4 合并建议

- 不建议把 `Desktop` 与 `Infrastructure` 直接合并
- 原因：UI 变化频繁，技术实现变化也频繁，混在一起会加速“巨型模块化”问题

---

## 6. 四个目录之间“关联是什么”

### 6.1 关联类型

1. **编译依赖关联**（`csproj` 引用关系）
2. **运行时关联**（DI 容器把接口绑定到实现）
3. **数据契约关联**（统一使用 Domain 模型）
4. **资源关联**（规则 JSON 从 Infrastructure/rules 打包到 Desktop 输出）

### 6.2 关键调用链（示例）

- 用户点击搜索（Desktop）
- `MainWindowViewModel` 调用 `ISearchBooksUseCase`（Application 接口）
- 实际执行 `HybridSearchBooksUseCase` / `RuleBasedSearchBooksUseCase`（Infrastructure）
- 返回 `SearchResult`（Domain）
- UI 渲染结果（Desktop）

下载、规则测试、封面刷新、书架读写也都是类似链路。

---

## 7. 是否可以合并？给你一个决策表

| 方案 | 变更 | 优点 | 风险 | 建议 |
|---|---|---|---|---|
| 维持四层 | 不合并 | 结构清晰、扩展性好 | 项目数较多 | **推荐（默认）** |
| 合并 Application + Infrastructure | 变成 3 层 | 减少项目数、开发更直接 | 抽象边界减弱，后续替换实现更难 | 小团队可选 |
| 合并 Domain 到其他层 | 变成 2 层/单层 | 项目最少 | 模型边界消失、长期维护成本高 | 不推荐 |
| 合并 Desktop + Infrastructure | UI + 实现同项目 | 初期最快 | 代码耦合快速上升 | 不推荐 |

---

## 8. 结合当前仓库的实用结论

1. 已合并的 `Rules` 项目是合理动作（它之前主要是规则资源容器）。
2. 当前四目录里，真正可讨论合并的是 `Application` 与 `Infrastructure`。
3. 若你近期目标是“减少工程复杂度”，可先观望一到两个迭代：
   - 如果接口层持续只有声明、无编排价值，再考虑合并。
   - 如果后续要接多端（CLI/Web）或替换实现，保留 `Application` 会更稳。

---

## 9. 一句话总结

四个目录当前分工是合理的：`Domain` 管数据模型、`Application` 管接口契约、`Infrastructure` 管外部实现、`Desktop` 管 UI 和组合根。它们通过编译依赖 + DI + 领域模型三条主线关联。若要继续简化，优先考虑 `Application` 与 `Infrastructure` 的策略性收敛，而不是动 `Domain` 或 `Desktop`。
