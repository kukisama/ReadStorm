<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:ReadStorm.Desktop.ViewModels"
             x:Class="ReadStorm.Desktop.Views.MainView"
             x:DataType="vm:MainWindowViewModel">
    <UserControl.Styles>
        <!--
            移除了所有显式 FontFamily 设置。
            MainActivity 中也移除了 .WithInterFont()，
            应用默认使用 Android 系统字体（Roboto + Noto CJK），天然支持中文。
        -->
        <Style Selector="Button">
            <Setter Property="MinHeight" Value="42" />
            <Setter Property="Padding" Value="14,8" />
            <Setter Property="FontSize" Value="15" />
        </Style>
        <Style Selector="TextBox">
            <Setter Property="MinHeight" Value="42" />
            <Setter Property="FontSize" Value="15" />
            <Setter Property="Padding" Value="10,6" />
        </Style>
        <Style Selector="ComboBox">
            <Setter Property="MinHeight" Value="42" />
            <Setter Property="FontSize" Value="15" />
        </Style>
        <Style Selector="TabItem">
            <Setter Property="FontSize" Value="15" />
            <Setter Property="Padding" Value="12,8" />
        </Style>
    </UserControl.Styles>

    <Grid RowDefinitions="Auto,*" Background="#F6F7F9">
        <Border Grid.Row="0" Background="#1E293B" Padding="14,10">
            <StackPanel Spacing="6">
                <TextBlock Text="ReadStorm Android"
                           FontSize="32"
                           FontWeight="Bold"
                           Foreground="White" />
                <TextBlock Text="{Binding StatusMessage}"
                           Foreground="#CBD5E1"
                           FontSize="13"
                           TextWrapping="Wrap"
                           MaxLines="2" />

                <!-- Debug 专用：字体与字重命中自检面板（Release 自动隐藏） -->
                <Border IsVisible="{Binding IsDebugBuild}"
                        Background="#0F172A"
                        BorderBrush="#334155"
                        BorderThickness="1"
                        CornerRadius="8"
                        Padding="10"
                        Margin="0,4,0,0">
                    <StackPanel Spacing="6">
                        <TextBlock Text="[DEBUG] 字体自检面板（Release 不显示）"
                                   Foreground="#FBBF24"
                                   FontWeight="Bold"
                                   FontSize="12" />
                        <TextBlock Text="当前策略：Debug=保守字重；Release=主题默认字重（更接近真机视觉）"
                                   Foreground="#93C5FD"
                                   FontSize="11"
                                   TextWrapping="Wrap" />

                        <StackPanel Spacing="2">
                            <TextBlock Text="Text-Normal：中文字体测试 你好，ReadStorm"
                                       Foreground="White"
                                       FontWeight="Normal"
                                       FontSize="13" />
                        </StackPanel>

                        <StackPanel Orientation="Horizontal" Spacing="6">
                            <Button Content="按钮-Normal" FontWeight="Normal" />
                            <Button Content="按钮-稳定模式" FontWeight="Normal" />
                        </StackPanel>
                    </StackPanel>
                </Border>
            </StackPanel>
        </Border>

        <!-- 索引顺序与 MainWindowViewModel 保持一致：0搜索 1任务 2诊断 3书架 4阅读 5规则 6设置 -->
        <TabControl Grid.Row="1" SelectedIndex="{Binding SelectedTabIndex}">
            <TabItem Header="搜索">
                <Grid DataContext="{Binding SearchDownload}" RowDefinitions="Auto,Auto,Auto,Auto,*" Margin="10" RowSpacing="8">
                    <Grid Grid.Row="0" ColumnDefinitions="*,Auto" ColumnSpacing="8">
                        <ComboBox Grid.Column="0"
                                  ItemsSource="{Binding Sources}"
                                  SelectedValueBinding="{ReflectionBinding Id}"
                                  SelectedValue="{Binding SelectedSourceId}">
                            <ComboBox.ItemTemplate>
                                <DataTemplate x:DataType="vm:SourceItem">
                                    <StackPanel Orientation="Horizontal" Spacing="6">
                                        <TextBlock Text="{Binding HealthDot}" Foreground="{Binding HealthColor}" />
                                        <TextBlock Text="{Binding Name}" />
                                    </StackPanel>
                                </DataTemplate>
                            </ComboBox.ItemTemplate>
                        </ComboBox>
                        <Button Grid.Column="1"
                                Content="刷新状态"
                                Command="{Binding RefreshSourceHealthCommand}" />
                    </Grid>

                    <Grid Grid.Row="1" ColumnDefinitions="*,Auto" ColumnSpacing="8">
                        <TextBox Grid.Column="0"
                                 Watermark="输入书名或作者"
                                 Text="{Binding SearchKeyword}" />
                        <Button Grid.Column="1"
                                Content="搜索"
                                MinWidth="88"
                                Command="{Binding SearchCommand}" />
                    </Grid>

                    <Button Grid.Row="2"
                            Content="加入下载队列"
                            Command="{Binding QueueDownloadCommand}" />

                    <TextBlock Grid.Row="3"
                               Text="未搜索到结果时，请先点击“刷新状态”获取可用书源"
                               Foreground="#64748B"
                               FontSize="12" />

                    <ListBox Grid.Row="4"
                             ItemsSource="{Binding SearchResults}"
                             SelectedItem="{Binding SelectedSearchResult}">
                        <ListBox.ItemTemplate>
                            <DataTemplate>
                                <Border BorderBrush="#E2E8F0" BorderThickness="1" CornerRadius="6" Padding="10" Margin="0,0,0,6">
                                    <StackPanel Spacing="4">
                                        <TextBlock Text="{Binding Title}" FontWeight="{DynamicResource CardTitleFontWeight}" TextWrapping="Wrap" FontSize="16" />
                                        <TextBlock Text="{Binding Author, StringFormat=作者：{0}}" FontSize="13" />
                                        <TextBlock Text="{Binding SourceName, StringFormat=来源：{0}}" FontSize="13" />
                                        <TextBlock Text="{Binding LatestChapter, StringFormat=最新：{0}}" FontSize="13" Foreground="#64748B" TextWrapping="Wrap" />
                                    </StackPanel>
                                </Border>
                            </DataTemplate>
                        </ListBox.ItemTemplate>
                    </ListBox>
                </Grid>
            </TabItem>

            <TabItem Header="任务">
                <Grid DataContext="{Binding SearchDownload}" RowDefinitions="Auto,*" Margin="10" RowSpacing="8">
                    <ComboBox Grid.Row="0"
                              ItemsSource="{Binding TaskFilterStatusOptions}"
                              SelectedItem="{Binding TaskFilterStatus}" />

                    <ListBox Grid.Row="1" ItemsSource="{Binding FilteredDownloadTasks}">
                        <ListBox.ItemTemplate>
                            <DataTemplate>
                                <Border BorderBrush="#E2E8F0" BorderThickness="1" CornerRadius="6" Padding="10" Margin="0,0,0,6">
                                    <StackPanel Spacing="4">
                                        <TextBlock Text="{Binding BookTitle}" FontWeight="{DynamicResource CardTitleFontWeight}" TextWrapping="Wrap" FontSize="16" />
                                        <TextBlock Text="{Binding Status, StringFormat=状态：{0}}" FontSize="13" />
                                        <TextBlock Text="{Binding ProgressPercent, StringFormat=进度：{0}%}" FontSize="13" Foreground="#2563EB" />
                                        <StackPanel Orientation="Horizontal" Spacing="6">
                                            <Button Content="暂停"
                                                    IsVisible="{Binding CanPause}"
                                                    Command="{Binding $parent[ListBox].DataContext.PauseDownloadCommand}"
                                                    CommandParameter="{Binding}" />
                                            <Button Content="恢复"
                                                    IsVisible="{Binding CanResume}"
                                                    Command="{Binding $parent[ListBox].DataContext.ResumeDownloadTaskCommand}"
                                                    CommandParameter="{Binding}" />
                                            <Button Content="重试"
                                                    IsVisible="{Binding CanRetry}"
                                                    Command="{Binding $parent[ListBox].DataContext.RetryDownloadCommand}"
                                                    CommandParameter="{Binding}" />
                                        </StackPanel>
                                    </StackPanel>
                                </Border>
                            </DataTemplate>
                        </ListBox.ItemTemplate>
                    </ListBox>
                </Grid>
            </TabItem>

            <TabItem Header="书源诊断">
                <Grid DataContext="{Binding Diagnostic}" RowDefinitions="Auto,Auto,Auto,*" Margin="10" RowSpacing="8">
                    <Button Grid.Row="0" Content="一键诊断全部书源" Command="{Binding RunBatchDiagnosticCommand}" />
                    <TextBlock Grid.Row="1" Text="{Binding DiagnosticSummary}" TextWrapping="Wrap" FontSize="13" Foreground="#334155" />
                    <ComboBox Grid.Row="2" ItemsSource="{Binding DiagnosticSourceNames}" SelectedItem="{Binding SelectedDiagnosticSource}" />
                    <ListBox Grid.Row="3" ItemsSource="{Binding DiagnosticLines}" />
                </Grid>
            </TabItem>

            <TabItem Header="书架">
                <Grid DataContext="{Binding Bookshelf}" RowDefinitions="Auto,*" Margin="10" RowSpacing="8">
                    <TextBox Grid.Row="0" Watermark="搜索书名或作者" Text="{Binding BookshelfFilterText}" />

                    <ListBox Grid.Row="1" ItemsSource="{Binding FilteredDbBooks}">
                        <ListBox.ItemTemplate>
                            <DataTemplate>
                                <Border BorderBrush="#E2E8F0" BorderThickness="1" CornerRadius="6" Padding="10" Margin="0,0,0,6">
                                    <StackPanel Spacing="4">
                                        <TextBlock Text="{Binding Title}" FontWeight="{DynamicResource CardTitleFontWeight}" TextWrapping="Wrap" FontSize="16" />
                                        <TextBlock Text="{Binding Author, StringFormat=作者：{0}}" FontSize="13" />
                                        <TextBlock Text="{Binding ProgressPercent, StringFormat=进度：{0}%}" FontSize="13" Foreground="#2563EB" />
                                        <StackPanel Orientation="Horizontal" Spacing="6">
                                            <Button Content="阅读"
                                                    Command="{Binding $parent[ListBox].DataContext.OpenDbBookCommand}"
                                                    CommandParameter="{Binding}" />
                                            <Button Content="续传"
                                                    IsVisible="{Binding CanResume}"
                                                    Command="{Binding $parent[ListBox].DataContext.ResumeBookDownloadCommand}"
                                                    CommandParameter="{Binding}" />
                                        </StackPanel>
                                    </StackPanel>
                                </Border>
                            </DataTemplate>
                        </ListBox.ItemTemplate>
                    </ListBox>
                </Grid>
            </TabItem>

            <TabItem Header="阅读" IsVisible="{Binding IsReaderTabVisible}">
                <Grid DataContext="{Binding Reader}" RowDefinitions="Auto,Auto,*" Margin="10" RowSpacing="8">
                    <TextBlock Grid.Row="0" Text="{Binding ReaderTitle}" FontWeight="{DynamicResource SectionTitleFontWeight}" FontSize="16" TextWrapping="Wrap" />
                    <StackPanel Grid.Row="1" Orientation="Horizontal" Spacing="6">
                        <Button Content="目录" Command="{Binding ToggleTocOverlayCommand}" />
                        <Button Content="上一章" Command="{Binding PreviousChapterCommand}" />
                        <Button Content="下一章" Command="{Binding NextChapterCommand}" />
                    </StackPanel>
                    <ScrollViewer Grid.Row="2" Background="{Binding ReaderBackground}">
                        <ItemsControl ItemsSource="{Binding ReaderParagraphs}" Margin="0,4,0,0" HorizontalAlignment="Stretch">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <TextBlock Text="{Binding}"
                                               Foreground="{Binding $parent[ItemsControl].DataContext.ReaderForeground}"
                                               FontSize="{Binding $parent[ItemsControl].DataContext.ReaderFontSize}"
                                               LineHeight="{Binding $parent[ItemsControl].DataContext.ReaderLineHeight}"
                                               Margin="{Binding $parent[ItemsControl].DataContext.ParagraphMargin}"
                                               TextWrapping="Wrap" />
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </ScrollViewer>
                </Grid>
            </TabItem>

            <TabItem Header="规则">
                <Grid DataContext="{Binding RuleEditor}" RowDefinitions="Auto,Auto,Auto,*" Margin="10" RowSpacing="8">
                    <StackPanel Grid.Row="0" Orientation="Horizontal" Spacing="6">
                        <Button Content="刷新" Command="{Binding LoadRuleListCommand}" />
                        <Button Content="新建" Command="{Binding NewRuleCommand}" />
                        <Button Content="复制" Command="{Binding CopyRuleCommand}" />
                        <Button Content="删除" Command="{Binding DeleteRuleCommand}" />
                    </StackPanel>

                    <Grid Grid.Row="1" ColumnDefinitions="*,Auto,Auto" ColumnSpacing="6">
                        <TextBox Grid.Column="0" Watermark="测试关键字" Text="{Binding RuleTestKeyword}" />
                        <Button Grid.Column="1" Content="测试" Command="{Binding TestRuleCommand}" />
                        <Button Grid.Column="2" Content="保存" Command="{Binding SaveRuleCommand}" />
                    </Grid>

                    <ComboBox Grid.Row="2" ItemsSource="{Binding RuleEditorRules}" SelectedItem="{Binding RuleEditorSelectedRule}">
                        <ComboBox.ItemTemplate>
                            <DataTemplate x:DataType="vm:RuleListItem">
                                <StackPanel Orientation="Horizontal" Spacing="6">
                                    <TextBlock Text="{Binding HealthDot}" Foreground="{Binding HealthColor}" />
                                    <TextBlock Text="{Binding Display}" />
                                </StackPanel>
                            </DataTemplate>
                        </ComboBox.ItemTemplate>
                    </ComboBox>

                    <ScrollViewer Grid.Row="3">
                        <StackPanel Spacing="8" Margin="0,0,0,10">
                            <TextBlock Text="规则基础配置" FontWeight="{DynamicResource SectionTitleFontWeight}" />
                            <TextBox Watermark="ID" Text="{Binding CurrentRule.Id}" />
                            <TextBox Watermark="名称" Text="{Binding CurrentRule.Name}" />
                            <TextBox Watermark="站点 URL" Text="{Binding CurrentRule.Url}" />
                            <TextBox Watermark="搜索 URL" Text="{Binding CurrentRule.Search.Url}" />
                            <TextBox Watermark="搜索结果选择器" Text="{Binding CurrentRule.Search.Result}" />
                            <TextBox Watermark="目录选择器" Text="{Binding CurrentRule.Toc.Item}" />
                            <TextBox Watermark="正文选择器" Text="{Binding CurrentRule.Chapter.Content}" />
                            <TextBlock Text="{Binding RuleTestStatus}" TextWrapping="Wrap" Foreground="#2563EB" />
                            <TextBox Text="{Binding RuleTestDiagnostics}"
                                     AcceptsReturn="True"
                                     TextWrapping="Wrap"
                                     IsReadOnly="True"
                                     MinHeight="220" />
                        </StackPanel>
                    </ScrollViewer>
                </Grid>
            </TabItem>

            <TabItem Header="设置">
                <ScrollViewer DataContext="{Binding Settings}">
                    <StackPanel Margin="10" Spacing="10">
                        <TextBlock Text="下载目录" FontWeight="{DynamicResource SectionTitleFontWeight}" />
                        <Grid ColumnDefinitions="*,Auto" ColumnSpacing="8">
                            <TextBox Grid.Column="0" Text="{Binding DownloadPath}" IsReadOnly="True" />
                            <Button Grid.Column="1" Content="浏览" Command="{Binding BrowseDownloadPathCommand}" />
                        </Grid>

                        <TextBlock Text="并发线程" FontWeight="{DynamicResource SectionTitleFontWeight}" />
                        <NumericUpDown Minimum="1" Maximum="64" Value="{Binding MaxConcurrency}" />

                        <TextBlock Text="聚合搜索并发" FontWeight="{DynamicResource SectionTitleFontWeight}" />
                        <NumericUpDown Minimum="1" Maximum="64" Value="{Binding AggregateSearchMaxConcurrency}" />

                        <TextBlock Text="导出格式" FontWeight="{DynamicResource SectionTitleFontWeight}" />
                        <ComboBox ItemsSource="{Binding ExportFormatOptions}" SelectedItem="{Binding ExportFormat}" />

                        <Button Content="保存设置" Command="{Binding SaveSettingsCommand}" />
                    </StackPanel>
                </ScrollViewer>
            </TabItem>
        </TabControl>
    </Grid>
</UserControl>
