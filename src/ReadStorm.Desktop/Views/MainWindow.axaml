<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:vm="using:ReadStorm.Desktop.ViewModels"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    mc:Ignorable="d" d:DesignWidth="1080" d:DesignHeight="720"
        x:Class="ReadStorm.Desktop.Views.MainWindow"
        x:DataType="vm:MainWindowViewModel"
        Icon="/Assets/avalonia-logo.ico"
    Title="{Binding Title}">

    <DockPanel LastChildFill="True" Margin="16">
        <Border DockPanel.Dock="Top" Background="#1F2937" CornerRadius="8" Padding="12" Margin="0,0,0,12">
            <StackPanel>
                <TextBlock Text="ReadStorm / M2 阅读器一体化" FontSize="20" FontWeight="Bold" Foreground="White" />
                <TextBlock Text="{Binding StatusMessage}" Foreground="#D1D5DB" />
                <TextBlock Text="{Binding AvailableSourceCount, StringFormat=当前规则数：{0}}" Foreground="#9CA3AF" />
            </StackPanel>
        </Border>

        <TabControl>
            <!-- ==================== 搜索下载 Tab ==================== -->
            <TabItem Header="搜索下载">
                <Grid RowDefinitions="Auto,Auto,Auto,*" ColumnDefinitions="*,Auto" RowSpacing="8" ColumnSpacing="8" Margin="8">
                    <ComboBox Grid.Row="0" Grid.Column="0"
                          ItemsSource="{Binding Sources}"
                          DisplayMemberBinding="{Binding Name}"
                          SelectedValueBinding="{Binding Id}"
                          SelectedValue="{Binding SelectedSourceId}" />

                    <TextBox Grid.Row="1" Grid.Column="0"
                             Watermark="输入书名或作者，例如：诡秘之主"
                             Text="{Binding SearchKeyword}" />
                    <Button Grid.Row="1" Grid.Column="1"
                            MinWidth="120"
                            Content="搜索"
                            Command="{Binding SearchCommand}" />

                    <Button Grid.Row="2" Grid.Column="1"
                            MinWidth="120"
                            Content="加入下载队列"
                            Command="{Binding QueueDownloadCommand}" />

                    <ListBox Grid.Row="3" Grid.Column="0" Grid.ColumnSpan="2"
                             ItemsSource="{Binding SearchResults}"
                             SelectedItem="{Binding SelectedSearchResult}">
                        <ListBox.ItemTemplate>
                            <DataTemplate>
                                <Border BorderBrush="#E5E7EB" BorderThickness="1" CornerRadius="6" Padding="10" Margin="0,0,0,6">
                                    <StackPanel>
                                        <TextBlock Text="{Binding Title}" FontWeight="Bold" />
                                        <TextBlock Text="{Binding Author, StringFormat=作者：{0}}" />
                                        <TextBlock Text="{Binding SourceId, StringFormat=书源ID：{0}}" />
                                        <TextBlock Text="{Binding LatestChapter, StringFormat=最新章节：{0}}" />
                                    </StackPanel>
                                </Border>
                            </DataTemplate>
                        </ListBox.ItemTemplate>
                    </ListBox>
                </Grid>
            </TabItem>

            <!-- ==================== 下载任务 Tab (Enhanced) ==================== -->
            <TabItem Header="下载任务">
                <DockPanel Margin="8">
                    <!-- Filter bar -->
                    <StackPanel DockPanel.Dock="Top" Orientation="Horizontal" Spacing="8" Margin="0,0,0,8">
                        <TextBlock Text="状态过滤：" VerticalAlignment="Center" FontWeight="Bold" />
                        <ComboBox SelectedItem="{Binding TaskFilterStatus}" MinWidth="120">
                            <ComboBoxItem Content="全部" IsSelected="True" />
                            <ComboBoxItem Content="Queued" />
                            <ComboBoxItem Content="Downloading" />
                            <ComboBoxItem Content="Succeeded" />
                            <ComboBoxItem Content="Failed" />
                            <ComboBoxItem Content="Cancelled" />
                            <ComboBoxItem Content="Paused" />
                        </ComboBox>
                    </StackPanel>

                    <ListBox ItemsSource="{Binding FilteredDownloadTasks}">
                        <ListBox.ItemTemplate>
                            <DataTemplate>
                                <Border BorderBrush="#E5E7EB" BorderThickness="1" CornerRadius="6" Padding="10" Margin="0,0,0,6">
                                    <Grid ColumnDefinitions="*,Auto" RowDefinitions="Auto">
                                        <StackPanel Grid.Column="0">
                                            <TextBlock Text="{Binding BookTitle}" FontWeight="Bold" />
                                            <TextBlock Text="{Binding Author, StringFormat=作者：{0}}" />
                                            <TextBlock Text="{Binding Status, StringFormat=状态：{0}}" />
                                            <TextBlock Text="{Binding ProgressPercent, StringFormat=进度：{0}%}" />
                                            <TextBlock Text="{Binding RetryCount, StringFormat=重试次数：{0}}" />
                                            <TextBlock Text="{Binding StateHistory.Count, StringFormat=状态节点：{0}}" />
                                            <TextBlock Text="{Binding OutputFilePath, StringFormat=输出：{0}}" TextWrapping="Wrap" />
                                            <TextBlock Text="{Binding ErrorKindDisplay}" TextWrapping="Wrap" Foreground="#F59E0B" />
                                            <TextBlock Text="{Binding ErrorDisplay}" TextWrapping="Wrap" Foreground="IndianRed" />
                                            <TextBlock Text="{Binding EnqueuedAt, StringFormat=入队时间：{0:yyyy-MM-dd HH:mm:ss}}" />
                                        </StackPanel>
                                        <StackPanel Grid.Column="1" Spacing="4" VerticalAlignment="Center">
                                            <Button Content="重试"
                                                    MinWidth="80"
                                                    IsVisible="{Binding CanRetry}"
                                                    Command="{Binding $parent[ListBox].((vm:MainWindowViewModel)DataContext).RetryDownloadCommand}"
                                                    CommandParameter="{Binding}" />
                                            <Button Content="取消"
                                                    MinWidth="80"
                                                    IsVisible="{Binding CanCancel}"
                                                    Command="{Binding $parent[ListBox].((vm:MainWindowViewModel)DataContext).CancelDownloadCommand}"
                                                    CommandParameter="{Binding}" />
                                        </StackPanel>
                                    </Grid>
                                </Border>
                            </DataTemplate>
                        </ListBox.ItemTemplate>
                    </ListBox>
                </DockPanel>
            </TabItem>

            <!-- ==================== 书源诊断 Tab ==================== -->
            <TabItem Header="书源诊断">
                <DockPanel Margin="8">
                    <StackPanel DockPanel.Dock="Top" Spacing="8">
                        <TextBlock Text="书源诊断面板" FontWeight="Bold" FontSize="16" />
                        <Grid ColumnDefinitions="Auto,*,Auto,*,Auto" ColumnSpacing="8">
                            <TextBlock Grid.Column="0" Text="书源ID：" VerticalAlignment="Center" />
                            <NumericUpDown Grid.Column="1" Minimum="1" Maximum="9999" Value="{Binding DiagnosticSourceId}" />
                            <TextBlock Grid.Column="2" Text="测试关键字：" VerticalAlignment="Center" />
                            <TextBox Grid.Column="3" Text="{Binding DiagnosticKeyword}" />
                            <Button Grid.Column="4" Content="开始诊断" MinWidth="100" Command="{Binding RunDiagnosticCommand}" />
                        </Grid>
                        <Border Background="#F3F4F6" CornerRadius="6" Padding="10" Margin="0,4,0,4">
                            <TextBlock Text="{Binding DiagnosticSummary}" TextWrapping="Wrap" FontWeight="SemiBold" />
                        </Border>
                    </StackPanel>

                    <ListBox ItemsSource="{Binding DiagnosticLines}" Margin="0,8,0,0">
                        <ListBox.ItemTemplate>
                            <DataTemplate>
                                <TextBlock Text="{Binding}" FontFamily="Consolas,Courier New,monospace" FontSize="12" TextWrapping="Wrap" />
                            </DataTemplate>
                        </ListBox.ItemTemplate>
                    </ListBox>
                </DockPanel>
            </TabItem>

            <!-- ==================== 书架 Tab ==================== -->
            <TabItem Header="书架">
                <DockPanel Margin="8">
                    <TextBlock DockPanel.Dock="Top" Text="我的书架" FontWeight="Bold" FontSize="16" Margin="0,0,0,8" />
                    <ListBox ItemsSource="{Binding BookshelfItems}">
                        <ListBox.ItemTemplate>
                            <DataTemplate>
                                <Border BorderBrush="#E5E7EB" BorderThickness="1" CornerRadius="6" Padding="10" Margin="0,0,0,6">
                                    <Grid ColumnDefinitions="*,Auto">
                                        <StackPanel Grid.Column="0">
                                            <TextBlock Text="{Binding Title}" FontWeight="Bold" FontSize="14" />
                                            <TextBlock Text="{Binding Author, StringFormat=作者：{0}}" />
                                            <TextBlock Text="{Binding Format, StringFormat=格式：{0}}" />
                                            <TextBlock Text="{Binding AddedAt, StringFormat=添加时间：{0:yyyy-MM-dd HH:mm}}" />
                                            <TextBlock Text="{Binding Progress.CurrentChapterTitle, StringFormat=上次阅读：{0}}" />
                                        </StackPanel>
                                        <StackPanel Grid.Column="1" Spacing="4" VerticalAlignment="Center">
                                            <Button Content="阅读"
                                                    MinWidth="80"
                                                    Command="{Binding $parent[ListBox].((vm:MainWindowViewModel)DataContext).OpenBookCommand}"
                                                    CommandParameter="{Binding}" />
                                            <Button Content="移除"
                                                    MinWidth="80"
                                                    Command="{Binding $parent[ListBox].((vm:MainWindowViewModel)DataContext).RemoveBookCommand}"
                                                    CommandParameter="{Binding}" />
                                        </StackPanel>
                                    </Grid>
                                </Border>
                            </DataTemplate>
                        </ListBox.ItemTemplate>
                    </ListBox>
                </DockPanel>
            </TabItem>

            <!-- ==================== 阅读器 Tab ==================== -->
            <TabItem Header="阅读">
                <DockPanel Margin="8">
                    <!-- Reader header -->
                    <StackPanel DockPanel.Dock="Top" Spacing="4" Margin="0,0,0,8">
                        <TextBlock Text="{Binding ReaderTitle}" FontWeight="Bold" FontSize="16" />
                        <Grid ColumnDefinitions="Auto,*,Auto,Auto" ColumnSpacing="8">
                            <TextBlock Grid.Column="0" Text="目录：" VerticalAlignment="Center" />
                            <ComboBox Grid.Column="1"
                                      ItemsSource="{Binding ReaderChapters}"
                                      SelectedItem="{Binding SelectedReaderChapter}" />
                            <Button Grid.Column="2" Content="上一章" MinWidth="80" Command="{Binding PreviousChapterCommand}" />
                            <Button Grid.Column="3" Content="下一章" MinWidth="80" Command="{Binding NextChapterCommand}" />
                        </Grid>
                    </StackPanel>

                    <!-- Reader content -->
                    <ScrollViewer>
                        <TextBlock Text="{Binding ReaderContent}"
                                   TextWrapping="Wrap"
                                   FontSize="15"
                                   LineHeight="28"
                                   Padding="16" />
                    </ScrollViewer>
                </DockPanel>
            </TabItem>

            <!-- ==================== 设置 Tab ==================== -->
            <TabItem Header="设置">
                <Grid Margin="8" ColumnDefinitions="160,*" RowDefinitions="Auto,Auto,Auto,Auto,Auto,Auto,Auto,Auto,Auto" ColumnSpacing="8" RowSpacing="8">
                    <TextBlock Grid.Row="0" Grid.Column="0" VerticalAlignment="Center" Text="下载目录" />
                    <TextBox Grid.Row="0" Grid.Column="1" Text="{Binding DownloadPath}" />

                    <TextBlock Grid.Row="1" Grid.Column="0" VerticalAlignment="Center" Text="并发线程" />
                    <NumericUpDown Grid.Row="1" Grid.Column="1" Minimum="1" Maximum="64" Value="{Binding MaxConcurrency}" />

                    <TextBlock Grid.Row="2" Grid.Column="0" VerticalAlignment="Center" Text="最小间隔(ms)" />
                    <NumericUpDown Grid.Row="2" Grid.Column="1" Minimum="50" Maximum="10000" Value="{Binding MinIntervalMs}" />

                    <TextBlock Grid.Row="3" Grid.Column="0" VerticalAlignment="Center" Text="最大间隔(ms)" />
                    <NumericUpDown Grid.Row="3" Grid.Column="1" Minimum="50" Maximum="20000" Value="{Binding MaxIntervalMs}" />

                    <TextBlock Grid.Row="4" Grid.Column="0" VerticalAlignment="Center" Text="导出格式" />
                    <ComboBox Grid.Row="4" Grid.Column="1" SelectedItem="{Binding ExportFormat}">
                        <ComboBoxItem Content="txt" />
                        <ComboBoxItem Content="epub" />
                    </ComboBox>

                    <TextBlock Grid.Row="5" Grid.Column="0" VerticalAlignment="Center" Text="启用代理" />
                    <CheckBox Grid.Row="5" Grid.Column="1" IsChecked="{Binding ProxyEnabled}" />

                    <TextBlock Grid.Row="6" Grid.Column="0" VerticalAlignment="Center" Text="代理主机" />
                    <TextBox Grid.Row="6" Grid.Column="1" Text="{Binding ProxyHost}" />

                    <TextBlock Grid.Row="7" Grid.Column="0" VerticalAlignment="Center" Text="代理端口" />
                    <NumericUpDown Grid.Row="7" Grid.Column="1" Minimum="1" Maximum="65535" Value="{Binding ProxyPort}" />

                    <Button Grid.Row="8" Grid.Column="1" HorizontalAlignment="Right" MinWidth="120" Content="保存设置" Command="{Binding SaveSettingsCommand}" />
                </Grid>
            </TabItem>
        </TabControl>
    </DockPanel>

</Window>
